"use strict";
/**
 * Test server for the Investment AI Agent frontend
 * This server provides mock responses for testing the frontend interface
 */
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const express_1 = __importDefault(require("express"));
const cors_1 = __importDefault(require("cors"));
const path_1 = __importDefault(require("path"));
const uuid_1 = require("uuid");
const app = (0, express_1.default)();
const PORT = process.env.PORT || 3000;
// Middleware
app.use((0, cors_1.default)());
app.use(express_1.default.json());
app.use(express_1.default.urlencoded({ extended: true }));
// Serve static files from frontend directory
app.use('/static', express_1.default.static(path_1.default.join(__dirname, '../frontend')));
// Mock data store
const mockRequests = new Map();
const mockUsers = new Map();
// Mock authentication middleware
const mockAuth = (req, res, next) => {
    // For testing, we'll use a mock user
    req.user = {
        userId: 'test-user-123',
        organizationId: 'test-org-123',
        role: 'analyst',
        permissions: ['read', 'write']
    };
    next();
};
// Frontend routes
app.get('/', (req, res) => {
    res.sendFile(path_1.default.join(__dirname, '../frontend/index.html'));
});
app.get('/styles.css', (req, res) => {
    res.setHeader('Content-Type', 'text/css');
    res.sendFile(path_1.default.join(__dirname, '../frontend/styles.css'));
});
app.get('/app.js', (req, res) => {
    res.setHeader('Content-Type', 'application/javascript');
    res.sendFile(path_1.default.join(__dirname, '../frontend/app.js'));
});
// Mock API endpoints
app.post('/api/v1/ideas/requests', mockAuth, (req, res) => {
    const requestId = (0, uuid_1.v4)();
    const request = {
        id: requestId,
        userId: req.user.userId,
        parameters: req.body.parameters,
        priority: req.body.priority || 'medium',
        timestamp: new Date(),
        status: 'submitted',
        estimatedProcessingTime: 120 // 2 minutes
    };
    mockRequests.set(requestId, request);
    // Simulate processing stages
    setTimeout(() => {
        const req = mockRequests.get(requestId);
        if (req) {
            req.status = 'validated';
            req.progress = { percentage: 20, currentPhase: 'validation' };
        }
    }, 2000);
    setTimeout(() => {
        const req = mockRequests.get(requestId);
        if (req) {
            req.status = 'processing';
            req.progress = { percentage: 50, currentPhase: 'research' };
        }
    }, 10000);
    setTimeout(() => {
        const req = mockRequests.get(requestId);
        if (req) {
            req.status = 'completed';
            req.progress = { percentage: 100, currentPhase: 'finalization' };
            req.results = generateMockResults(req.parameters);
        }
    }, 30000);
    res.status(202).json({
        message: 'Investment idea request submitted successfully',
        requestId,
        status: request.status,
        estimatedProcessingTime: request.estimatedProcessingTime,
        trackingUrl: `/api/v1/ideas/requests/${requestId}/status`
    });
});
app.get('/api/v1/ideas/requests/:requestId/status', mockAuth, (req, res) => {
    const { requestId } = req.params;
    const request = mockRequests.get(requestId);
    if (!request) {
        res.status(404).json({
            error: 'Request not found',
            code: 'REQUEST_NOT_FOUND'
        });
        return;
    }
    res.json({
        requestId,
        status: request.status,
        progress: request.progress || { percentage: 10, currentPhase: 'validation' },
        estimatedTimeRemaining: request.status === 'completed' ? 0 : 15,
        currentStep: request.status,
        results: request.results,
        lastUpdated: new Date()
    });
});
app.get('/api/v1/ideas/requests/:requestId/results', mockAuth, (req, res) => {
    const { requestId } = req.params;
    const request = mockRequests.get(requestId);
    if (!request) {
        res.status(404).json({
            error: 'Request results not found',
            code: 'RESULTS_NOT_FOUND'
        });
        return;
    }
    if (request.status !== 'completed') {
        res.status(202).json({
            message: 'Request still processing',
            status: request.status,
            requestId
        });
        return;
    }
    res.json({
        requestId,
        status: request.status,
        investmentIdeas: request.results.investmentIdeas,
        processingMetrics: request.results.processingMetrics,
        generatedAt: request.results.generatedAt,
        metadata: request.results.metadata
    });
});
app.delete('/api/v1/ideas/requests/:requestId', mockAuth, (req, res) => {
    const { requestId } = req.params;
    const request = mockRequests.get(requestId);
    if (!request) {
        res.status(404).json({
            error: 'Request not found or cannot be cancelled',
            code: 'CANCELLATION_FAILED'
        });
        return;
    }
    request.status = 'cancelled';
    res.json({
        message: 'Request cancelled successfully',
        requestId,
        status: 'cancelled'
    });
});
app.get('/api/v1/ideas/requests', mockAuth, (req, res) => {
    const { page = 1, limit = 10 } = req.query;
    const userRequests = Array.from(mockRequests.values())
        .filter(request => request.userId === req.user?.userId)
        .sort((a, b) => new Date(b.timestamp).getTime() - new Date(a.timestamp).getTime());
    const startIndex = (parseInt(page) - 1) * parseInt(limit);
    const endIndex = startIndex + parseInt(limit);
    const paginatedRequests = userRequests.slice(startIndex, endIndex);
    res.json({
        requests: paginatedRequests.map(req => ({
            id: req.id,
            parameters: req.parameters,
            status: req.status,
            priority: req.priority,
            submittedAt: req.timestamp,
            completedAt: req.status === 'completed' ? new Date() : undefined,
            processingTime: req.status === 'completed' ? 30000 : undefined,
            resultCount: req.results?.investmentIdeas?.length || 0,
            qualityScore: req.results ? 85 : undefined
        })),
        pagination: {
            page: parseInt(page),
            limit: parseInt(limit),
            total: userRequests.length,
            totalPages: Math.ceil(userRequests.length / parseInt(limit))
        }
    });
});
app.post('/api/v1/ideas/requests/:requestId/feedback', mockAuth, (req, res) => {
    const { requestId } = req.params;
    const request = mockRequests.get(requestId);
    if (!request) {
        res.status(404).json({
            error: 'Request not found',
            code: 'REQUEST_NOT_FOUND'
        });
        return;
    }
    const feedbackId = (0, uuid_1.v4)();
    res.json({
        message: 'Feedback submitted successfully',
        requestId,
        feedbackId
    });
});
// Helper function to generate mock results
function generateMockResults(parameters) {
    const investmentIdeas = [];
    const maxIdeas = parameters.maximumIdeas || 5;
    for (let i = 0; i < Math.min(maxIdeas, 3); i++) {
        investmentIdeas.push({
            id: (0, uuid_1.v4)(),
            title: `Investment Opportunity ${i + 1}`,
            description: `A ${parameters.riskTolerance} investment opportunity in the ${parameters.investmentHorizon} timeframe.`,
            rationale: `Based on current market conditions and your ${parameters.riskTolerance} risk tolerance, this investment aligns with your ${parameters.investmentHorizon} investment horizon. The analysis shows strong fundamentals and positive market sentiment.`,
            confidenceScore: Math.floor(Math.random() * 30) + 70,
            timeHorizon: parameters.investmentHorizon,
            potentialReturn: {
                best: Math.floor(Math.random() * 20) + 15,
                expected: Math.floor(Math.random() * 15) + 8,
                worst: Math.floor(Math.random() * 10) - 5
            },
            riskFactors: [
                {
                    level: 'medium',
                    description: 'Market volatility may impact short-term performance'
                },
                {
                    level: 'low',
                    description: 'Regulatory changes in the sector'
                }
            ],
            supportingData: [
                {
                    source: 'Market Analysis',
                    type: 'fundamental',
                    value: 'Strong earnings growth',
                    timestamp: new Date(),
                    reliability: 0.9
                }
            ],
            complianceConsiderations: []
        });
    }
    return {
        investmentIdeas,
        processingMetrics: {
            totalProcessingTime: 30000,
            modelExecutionTime: 15000,
            dataRetrievalTime: 8000,
            validationTime: 2000
        },
        generatedAt: new Date(),
        metadata: {
            generationMethod: 'multi-agent',
            researchSources: ['Market Data', 'Financial Reports', 'News Analysis'],
            marketDataTimestamp: new Date(),
            complianceVersion: '1.0.0'
        }
    };
}
// Health check
app.get('/health', (req, res) => {
    res.json({ status: 'ok', service: 'Investment AI Agent Test Server' });
});
// Start server
app.listen(PORT, () => {
    console.log(`Investment AI Agent test server running on port ${PORT}`);
    console.log(`Frontend available at: http://localhost:${PORT}`);
    console.log(`API documentation at: http://localhost:${PORT}/api-docs`);
});
exports.default = app;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGVzdC1zZXJ2ZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvYXBpL3Rlc3Qtc2VydmVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQTs7O0dBR0c7Ozs7O0FBRUgsc0RBQXFEO0FBQ3JELGdEQUF3QjtBQUN4QixnREFBd0I7QUFDeEIsK0JBQW9DO0FBWXBDLE1BQU0sR0FBRyxHQUFHLElBQUEsaUJBQU8sR0FBRSxDQUFDO0FBQ3RCLE1BQU0sSUFBSSxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsSUFBSSxJQUFJLElBQUksQ0FBQztBQUV0QyxhQUFhO0FBQ2IsR0FBRyxDQUFDLEdBQUcsQ0FBQyxJQUFBLGNBQUksR0FBRSxDQUFDLENBQUM7QUFDaEIsR0FBRyxDQUFDLEdBQUcsQ0FBQyxpQkFBTyxDQUFDLElBQUksRUFBRSxDQUFDLENBQUM7QUFDeEIsR0FBRyxDQUFDLEdBQUcsQ0FBQyxpQkFBTyxDQUFDLFVBQVUsQ0FBQyxFQUFFLFFBQVEsRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDLENBQUM7QUFFaEQsNkNBQTZDO0FBQzdDLEdBQUcsQ0FBQyxHQUFHLENBQUMsU0FBUyxFQUFFLGlCQUFPLENBQUMsTUFBTSxDQUFDLGNBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFFLGFBQWEsQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUV4RSxrQkFBa0I7QUFDbEIsTUFBTSxZQUFZLEdBQUcsSUFBSSxHQUFHLEVBQUUsQ0FBQztBQUMvQixNQUFNLFNBQVMsR0FBRyxJQUFJLEdBQUcsRUFBRSxDQUFDO0FBRTVCLGlDQUFpQztBQUNqQyxNQUFNLFFBQVEsR0FBRyxDQUFDLEdBQXlCLEVBQUUsR0FBYSxFQUFFLElBQTBCLEVBQUUsRUFBRTtJQUN4RixxQ0FBcUM7SUFDckMsR0FBRyxDQUFDLElBQUksR0FBRztRQUNULE1BQU0sRUFBRSxlQUFlO1FBQ3ZCLGNBQWMsRUFBRSxjQUFjO1FBQzlCLElBQUksRUFBRSxTQUFTO1FBQ2YsV0FB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ICogVGVzdCBzZXJ2ZXIgZm9yIHRoZSBJbnZlc3RtZW50IEFJIEFnZW50IGZyb250ZW5kXG4gKiBUaGlzIHNlcnZlciBwcm92aWRlcyBtb2NrIHJlc3BvbnNlcyBmb3IgdGVzdGluZyB0aGUgZnJvbnRlbmQgaW50ZXJmYWNlXG4gKi9cblxuaW1wb3J0IGV4cHJlc3MsIHsgUmVxdWVzdCwgUmVzcG9uc2UgfSBmcm9tICdleHByZXNzJztcbmltcG9ydCBjb3JzIGZyb20gJ2NvcnMnO1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgeyB2NCBhcyB1dWlkdjQgfSBmcm9tICd1dWlkJztcblxuLy8gRXh0ZW5kIFJlcXVlc3QgdHlwZSBmb3IgdGVzdGluZ1xuaW50ZXJmYWNlIEF1dGhlbnRpY2F0ZWRSZXF1ZXN0IGV4dGVuZHMgUmVxdWVzdCB7XG4gIHVzZXI/OiB7XG4gICAgdXNlcklkOiBzdHJpbmc7XG4gICAgb3JnYW5pemF0aW9uSWQ6IHN0cmluZztcbiAgICByb2xlOiBzdHJpbmc7XG4gICAgcGVybWlzc2lvbnM6IHN0cmluZ1tdO1xuICB9O1xufVxuXG5jb25zdCBhcHAgPSBleHByZXNzKCk7XG5jb25zdCBQT1JUID0gcHJvY2Vzcy5lbnYuUE9SVCB8fCAzMDAwO1xuXG4vLyBNaWRkbGV3YXJlXG5hcHAudXNlKGNvcnMoKSk7XG5hcHAudXNlKGV4cHJlc3MuanNvbigpKTtcbmFwcC51c2UoZXhwcmVzcy51cmxlbmNvZGVkKHsgZXh0ZW5kZWQ6IHRydWUgfSkpO1xuXG4vLyBTZXJ2ZSBzdGF0aWMgZmlsZXMgZnJvbSBmcm9udGVuZCBkaXJlY3RvcnlcbmFwcC51c2UoJy9zdGF0aWMnLCBleHByZXNzLnN0YXRpYyhwYXRoLmpvaW4oX19kaXJuYW1lLCAnLi4vZnJvbnRlbmQnKSkpO1xuXG4vLyBNb2NrIGRhdGEgc3RvcmVcbmNvbnN0IG1vY2tSZXF1ZXN0cyA9IG5ldyBNYXAoKTtcbmNvbnN0IG1vY2tVc2VycyA9IG5ldyBNYXAoKTtcblxuLy8gTW9jayBhdXRoZW50aWNhdGlvbiBtaWRkbGV3YXJlXG5jb25zdCBtb2NrQXV0aCA9IChyZXE6IEF1dGhlbnRpY2F0ZWRSZXF1ZXN0LCByZXM6IFJlc3BvbnNlLCBuZXh0OiBleHByZXNzLk5leHRGdW5jdGlvbikgPT4ge1xuICAvLyBGb3IgdGVzdGluZywgd2UnbGwgdXNlIGEgbW9jayB1c2VyXG4gIHJlcS51c2VyID0ge1xuICAgIHVzZXJJZDogJ3Rlc3QtdXNlci0xMjMnLFxuICAgIG9yZ2FuaXphdGlvbklkOiAndGVzdC1vcmctMTIzJyxcbiAgICByb2xlOiAnYW5hbHlzdCcsXG4gICAgcGVybWlzc2lvbnM6IFsncmVhZCcsICd3cml0ZSddXG4gIH07XG4gIG5leHQoKTtcbn07XG5cbi8vIEZyb250ZW5kIHJvdXRlc1xuYXBwLmdldCgnLycsIChyZXEsIHJlcykgPT4ge1xuICByZXMuc2VuZEZpbGUocGF0aC5qb2luKF9fZGlybmFtZSwgJy4uL2Zyb250ZW5kL2luZGV4Lmh0bWwnKSk7XG59KTtcblxuYXBwLmdldCgnL3N0eWxlcy5jc3MnLCAocmVxLCByZXMpID0+IHtcbiAgcmVzLnNldEhlYWRlcignQ29udGVudC1UeXBlJywgJ3RleHQvY3NzJyk7XG4gIHJlcy5zZW5kRmlsZShwYXRoLmpvaW4oX19kaXJuYW1lLCAnLi4vZnJvbnRlbmQvc3R5bGVzLmNzcycpKTtcbn0pO1xuXG5hcHAuZ2V0KCcvYXBwLmpzJywgKHJlcSwgcmVzKSA9PiB7XG4gIHJlcy5zZXRIZWFkZXIoJ0NvbnRlbnQtVHlwZScsICdhcHBsaWNhdGlvbi9qYXZhc2NyaXB0Jyk7XG4gIHJlcy5zZW5kRmlsZShwYXRoLmpvaW4oX19kaXJuYW1lLCAnLi4vZnJvbnRlbmQvYXBwLmpzJykpO1xufSk7XG5cbi8vIE1vY2sgQVBJIGVuZHBvaW50c1xuYXBwLnBvc3QoJy9hcGkvdjEvaWRlYXMvcmVxdWVzdHMnLCBtb2NrQXV0aCwgKHJlcTogQXV0aGVudGljYXRlZFJlcXVlc3QsIHJlczogUmVzcG9uc2UpID0+IHtcbiAgY29uc3QgcmVxdWVzdElkID0gdXVpZHY0KCk7XG4gIGNvbnN0IHJlcXVlc3QgPSB7XG4gICAgaWQ6IHJlcXVlc3RJZCxcbiAgICB1c2VySWQ6IHJlcS51c2VyIS51c2VySWQsXG4gICAgcGFyYW1ldGVyczogcmVxLmJvZHkucGFyYW1ldGVycyxcbiAgICBwcmlvcml0eTogcmVxLmJvZHkucHJpb3JpdHkgfHwgJ21lZGl1bScsXG4gICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLFxuICAgIHN0YXR1czogJ3N1Ym1pdHRlZCcsXG4gICAgZXN0aW1hdGVkUHJvY2Vzc2luZ1RpbWU6IDEyMCAvLyAyIG1pbnV0ZXNcbiAgfTtcblxuICBtb2NrUmVxdWVzdHMuc2V0KHJlcXVlc3RJZCwgcmVxdWVzdCk7XG5cbiAgLy8gU2ltdWxhdGUgcHJvY2Vzc2luZyBzdGFnZXNcbiAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgY29uc3QgcmVxID0gbW9ja1JlcXVlc3RzLmdldChyZXF1ZXN0SWQpO1xuICAgIGlmIChyZXEpIHtcbiAgICAgIHJlcS5zdGF0dXMgPSAndmFsaWRhdGVkJztcbiAgICAgIHJlcS5wcm9ncmVzcyA9IHsgcGVyY2VudGFnZTogMjAsIGN1cnJlbnRQaGFzZTogJ3ZhbGlkYXRpb24nIH07XG4gICAgfVxuICB9LCAyMDAwKTtcblxuICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICBjb25zdCByZXEgPSBtb2NrUmVxdWVzdHMuZ2V0KHJlcXVlc3RJZCk7XG4gICAgaWYgKHJlcSkge1xuICAgICAgcmVxLnN0YXR1cyA9ICdwcm9jZXNzaW5nJztcbiAgICAgIHJlcS5wcm9ncmVzcyA9IHsgcGVyY2VudGFnZTogNTAsIGN1cnJlbnRQaGFzZTogJ3Jlc2VhcmNoJyB9O1xuICAgIH1cbiAgfSwgMTAwMDApO1xuXG4gIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgIGNvbnN0IHJlcSA9IG1vY2tSZXF1ZXN0cy5nZXQocmVxdWVzdElkKTtcbiAgICBpZiAocmVxKSB7XG4gICAgICByZXEuc3RhdHVzID0gJ2NvbXBsZXRlZCc7XG4gICAgICByZXEucHJvZ3Jlc3MgPSB7IHBlcmNlbnRhZ2U6IDEwMCwgY3VycmVudFBoYXNlOiAnZmluYWxpemF0aW9uJyB9O1xuICAgICAgcmVxLnJlc3VsdHMgPSBnZW5lcmF0ZU1vY2tSZXN1bHRzKHJlcS5wYXJhbWV0ZXJzKTtcbiAgICB9XG4gIH0sIDMwMDAwKTtcblxuICByZXMuc3RhdHVzKDIwMikuanNvbih7XG4gICAgbWVzc2FnZTogJ0ludmVzdG1lbnQgaWRlYSByZXF1ZXN0IHN1Ym1pdHRlZCBzdWNjZXNzZnVsbHknLFxuICAgIHJlcXVlc3RJZCxcbiAgICBzdGF0dXM6IHJlcXVlc3Quc3RhdHVzLFxuICAgIGVzdGltYXRlZFByb2Nlc3NpbmdUaW1lOiByZXF1ZXN0LmVzdGltYXRlZFByb2Nlc3NpbmdUaW1lLFxuICAgIHRyYWNraW5nVXJsOiBgL2FwaS92MS9pZGVhcy9yZXF1ZXN0cy8ke3JlcXVlc3RJZH0vc3RhdHVzYFxuICB9KTtcbn0pO1xuXG5hcHAuZ2V0KCcvYXBpL3YxL2lkZWFzL3JlcXVlc3RzLzpyZXF1ZXN0SWQvc3RhdHVzJywgbW9ja0F1dGgsIChyZXE6IEF1dGhlbnRpY2F0ZWRSZXF1ZXN0LCByZXM6IFJlc3BvbnNlKSA9PiB7XG4gIGNvbnN0IHsgcmVxdWVzdElkIH0gPSByZXEucGFyYW1zO1xuICBjb25zdCByZXF1ZXN0ID0gbW9ja1JlcXVlc3RzLmdldChyZXF1ZXN0SWQpO1xuXG4gIGlmICghcmVxdWVzdCkge1xuICAgIHJlcy5zdGF0dXMoNDA0KS5qc29uKHtcbiAgICAgIGVycm9yOiAnUmVxdWVzdCBub3QgZm91bmQnLFxuICAgICAgY29kZTogJ1JFUVVFU1RfTk9UX0ZPVU5EJ1xuICAgIH0pO1xuICAgIHJldHVybjtcbiAgfVxuXG4gIHJlcy5qc29uKHtcbiAgICByZXF1ZXN0SWQsXG4gICAgc3RhdHVzOiByZXF1ZXN0LnN0YXR1cyxcbiAgICBwcm9ncmVzczogcmVxdWVzdC5wcm9ncmVzcyB8fCB7IHBlcmNlbnRhZ2U6IDEwLCBjdXJyZW50UGhhc2U6ICd2YWxpZGF0aW9uJyB9LFxuICAgIGVzdGltYXRlZFRpbWVSZW1haW5pbmc6IHJlcXVlc3Quc3RhdHVzID09PSAnY29tcGxldGVkJyA/IDAgOiAxNSxcbiAgICBjdXJyZW50U3RlcDogcmVxdWVzdC5zdGF0dXMsXG4gICAgcmVzdWx0czogcmVxdWVzdC5yZXN1bHRzLFxuICAgIGxhc3RVcGRhdGVkOiBuZXcgRGF0ZSgpXG4gIH0pO1xufSk7XG5cbmFwcC5nZXQoJy9hcGkvdjEvaWRlYXMvcmVxdWVzdHMvOnJlcXVlc3RJZC9yZXN1bHRzJywgbW9ja0F1dGgsIChyZXE6IEF1dGhlbnRpY2F0ZWRSZXF1ZXN0LCByZXM6IFJlc3BvbnNlKSA9PiB7XG4gIGNvbnN0IHsgcmVxdWVzdElkIH0gPSByZXEucGFyYW1zO1xuICBjb25zdCByZXF1ZXN0ID0gbW9ja1JlcXVlc3RzLmdldChyZXF1ZXN0SWQpO1xuXG4gIGlmICghcmVxdWVzdCkge1xuICAgIHJlcy5zdGF0dXMoNDA0KS5qc29uKHtcbiAgICAgIGVycm9yOiAnUmVxdWVzdCByZXN1bHRzIG5vdCBmb3VuZCcsXG4gICAgICBjb2RlOiAnUkVTVUxUU19OT1RfRk9VTkQnXG4gICAgfSk7XG4gICAgcmV0dXJuO1xuICB9XG5cbiAgaWYgKHJlcXVlc3Quc3RhdHVzICE9PSAnY29tcGxldGVkJykge1xuICAgIHJlcy5zdGF0dXMoMjAyKS5qc29uKHtcbiAgICAgIG1lc3NhZ2U6ICdSZXF1ZXN0IHN0aWxsIHByb2Nlc3NpbmcnLFxuICAgICAgc3RhdHVzOiByZXF1ZXN0LnN0YXR1cyxcbiAgICAgIHJlcXVlc3RJZFxuICAgIH0pO1xuICAgIHJldHVybjtcbiAgfVxuXG4gIHJlcy5qc29uKHtcbiAgICByZXF1ZXN0SWQsXG4gICAgc3RhdHVzOiByZXF1ZXN0LnN0YXR1cyxcbiAgICBpbnZlc3RtZW50SWRlYXM6IHJlcXVlc3QucmVzdWx0cy5pbnZlc3RtZW50SWRlYXMsXG4gICAgcHJvY2Vzc2luZ01ldHJpY3M6IHJlcXVlc3QucmVzdWx0cy5wcm9jZXNzaW5nTWV0cmljcyxcbiAgICBnZW5lcmF0ZWRBdDogcmVxdWVzdC5yZXN1bHRzLmdlbmVyYXRlZEF0LFxuICAgIG1ldGFkYXRhOiByZXF1ZXN0LnJlc3VsdHMubWV0YWRhdGFcbiAgfSk7XG59KTtcblxuYXBwLmRlbGV0ZSgnL2FwaS92MS9pZGVhcy9yZXF1ZXN0cy86cmVxdWVzdElkJywgbW9ja0F1dGgsIChyZXE6IEF1dGhlbnRpY2F0ZWRSZXF1ZXN0LCByZXM6IFJlc3BvbnNlKSA9PiB7XG4gIGNvbnN0IHsgcmVxdWVzdElkIH0gPSByZXEucGFyYW1zO1xuICBjb25zdCByZXF1ZXN0ID0gbW9ja1JlcXVlc3RzLmdldChyZXF1ZXN0SWQpO1xuXG4gIGlmICghcmVxdWVzdCkge1xuICAgIHJlcy5zdGF0dXMoNDA0KS5qc29uKHtcbiAgICAgIGVycm9yOiAnUmVxdWVzdCBub3QgZm91bmQgb3IgY2Fubm90IGJlIGNhbmNlbGxlZCcsXG4gICAgICBjb2RlOiAnQ0FOQ0VMTEFUSU9OX0ZBSUxFRCdcbiAgICB9KTtcbiAgICByZXR1cm47XG4gIH1cblxuICByZXF1ZXN0LnN0YXR1cyA9ICdjYW5jZWxsZWQnO1xuICBcbiAgcmVzLmpzb24oe1xuICAgIG1lc3NhZ2U6ICdSZXF1ZXN0IGNhbmNlbGxlZCBzdWNjZXNzZnVsbHknLFxuICAgIHJlcXVlc3RJZCxcbiAgICBzdGF0dXM6ICdjYW5jZWxsZWQnXG4gIH0pO1xufSk7XG5cbmFwcC5nZXQoJy9hcGkvdjEvaWRlYXMvcmVxdWVzdHMnLCBtb2NrQXV0aCwgKHJlcTogQXV0aGVudGljYXRlZFJlcXVlc3QsIHJlczogUmVzcG9uc2UpID0+IHtcbiAgY29uc3QgeyBwYWdlID0gMSwgbGltaXQgPSAxMCB9ID0gcmVxLnF1ZXJ5O1xuICBjb25zdCB1c2VyUmVxdWVzdHMgPSBBcnJheS5mcm9tKG1vY2tSZXF1ZXN0cy52YWx1ZXMoKSlcbiAgICAuZmlsdGVyKHJlcXVlc3QgPT4gcmVxdWVzdC51c2VySWQgPT09IHJlcS51c2VyPy51c2VySWQpXG4gICAgLnNvcnQoKGEsIGIpID0+IG5ldyBEYXRlKGIudGltZXN0YW1wKS5nZXRUaW1lKCkgLSBuZXcgRGF0ZShhLnRpbWVzdGFtcCkuZ2V0VGltZSgpKTtcblxuICBjb25zdCBzdGFydEluZGV4ID0gKHBhcnNlSW50KHBhZ2UgYXMgc3RyaW5nKSAtIDEpICogcGFyc2VJbnQobGltaXQgYXMgc3RyaW5nKTtcbiAgY29uc3QgZW5kSW5kZXggPSBzdGFydEluZGV4ICsgcGFyc2VJbnQobGltaXQgYXMgc3RyaW5nKTtcbiAgY29uc3QgcGFnaW5hdGVkUmVxdWVzdHMgPSB1c2VyUmVxdWVzdHMuc2xpY2Uoc3RhcnRJbmRleCwgZW5kSW5kZXgpO1xuXG4gIHJlcy5qc29uKHtcbiAgICByZXF1ZXN0czogcGFnaW5hdGVkUmVxdWVzdHMubWFwKHJlcSA9PiAoe1xuICAgICAgaWQ6IHJlcS5pZCxcbiAgICAgIHBhcmFtZXRlcnM6IHJlcS5wYXJhbWV0ZXJzLFxuICAgICAgc3RhdHVzOiByZXEuc3RhdHVzLFxuICAgICAgcHJpb3JpdHk6IHJlcS5wcmlvcml0eSxcbiAgICAgIHN1Ym1pdHRlZEF0OiByZXEudGltZXN0YW1wLFxuICAgICAgY29tcGxldGVkQXQ6IHJlcS5zdGF0dXMgPT09ICdjb21wbGV0ZWQnID8gbmV3IERhdGUoKSA6IHVuZGVmaW5lZCxcbiAgICAgIHByb2Nlc3NpbmdUaW1lOiByZXEuc3RhdHVzID09PSAnY29tcGxldGVkJyA/IDMwMDAwIDogdW5kZWZpbmVkLFxuICAgICAgcmVzdWx0Q291bnQ6IHJlcS5yZXN1bHRzPy5pbnZlc3RtZW50SWRlYXM/Lmxlbmd0aCB8fCAwLFxuICAgICAgcXVhbGl0eVNjb3JlOiByZXEucmVzdWx0cyA/IDg1IDogdW5kZWZpbmVkXG4gICAgfSkpLFxuICAgIHBhZ2luYXRpb246IHtcbiAgICAgIHBhZ2U6IHBhcnNlSW50KHBhZ2UgYXMgc3RyaW5nKSxcbiAgICAgIGxpbWl0OiBwYXJzZUludChsaW1pdCBhcyBzdHJpbmcpLFxuICAgICAgdG90YWw6IHVzZXJSZXF1ZXN0cy5sZW5ndGgsXG4gICAgICB0b3RhbFBhZ2VzOiBNYXRoLmNlaWwodXNlclJlcXVlc3RzLmxlbmd0aCAvIHBhcnNlSW50KGxpbWl0IGFzIHN0cmluZykpXG4gICAgfVxuICB9KTtcbn0pO1xuXG5hcHAucG9zdCgnL2FwaS92MS9pZGVhcy9yZXF1ZXN0cy86cmVxdWVzdElkL2ZlZWRiYWNrJywgbW9ja0F1dGgsIChyZXE6IEF1dGhlbnRpY2F0ZWRSZXF1ZXN0LCByZXM6IFJlc3BvbnNlKSA9PiB7XG4gIGNvbnN0IHsgcmVxdWVzdElkIH0gPSByZXEucGFyYW1zO1xuICBjb25zdCByZXF1ZXN0ID0gbW9ja1JlcXVlc3RzLmdldChyZXF1ZXN0SWQpO1xuXG4gIGlmICghcmVxdWVzdCkge1xuICAgIHJlcy5zdGF0dXMoNDA0KS5qc29uKHtcbiAgICAgIGVycm9yOiAnUmVxdWVzdCBub3QgZm91bmQnLFxuICAgICAgY29kZTogJ1JFUVVFU1RfTk9UX0ZPVU5EJ1xuICAgIH0pO1xuICAgIHJldHVybjtcbiAgfVxuXG4gIGNvbnN0IGZlZWRiYWNrSWQgPSB1dWlkdjQoKTtcbiAgXG4gIHJlcy5qc29uKHtcbiAgICBtZXNzYWdlOiAnRmVlZGJhY2sgc3VibWl0dGVkIHN1Y2Nlc3NmdWxseScsXG4gICAgcmVxdWVzdElkLFxuICAgIGZlZWRiYWNrSWRcbiAgfSk7XG59KTtcblxuLy8gSGVscGVyIGZ1bmN0aW9uIHRvIGdlbmVyYXRlIG1vY2sgcmVzdWx0c1xuZnVuY3Rpb24gZ2VuZXJhdGVNb2NrUmVzdWx0cyhwYXJhbWV0ZXJzOiBhbnkpIHtcbiAgY29uc3QgaW52ZXN0bWVudElkZWFzID0gW107XG4gIGNvbnN0IG1heElkZWFzID0gcGFyYW1ldGVycy5tYXhpbXVtSWRlYXMgfHwgNTtcblxuICBmb3IgKGxldCBpID0gMDsgaSA8IE1hdGgubWluKG1heElkZWFzLCAzKTsgaSsrKSB7XG4gICAgaW52ZXN0bWVudElkZWFzLnB1c2goe1xuICAgICAgaWQ6IHV1aWR2NCgpLFxuICAgICAgdGl0bGU6IGBJbnZlc3RtZW50IE9wcG9ydHVuaXR5ICR7aSArIDF9YCxcbiAgICAgIGRlc2NyaXB0aW9uOiBgQSAke3BhcmFtZXRlcnMucmlza1RvbGVyYW5jZX0gaW52ZXN0bWVudCBvcHBvcnR1bml0eSBpbiB0aGUgJHtwYXJhbWV0ZXJzLmludmVzdG1lbnRIb3Jpem9ufSB0aW1lZnJhbWUuYCxcbiAgICAgIHJhdGlvbmFsZTogYEJhc2VkIG9uIGN1cnJlbnQgbWFya2V0IGNvbmRpdGlvbnMgYW5kIHlvdXIgJHtwYXJhbWV0ZXJzLnJpc2tUb2xlcmFuY2V9IHJpc2sgdG9sZXJhbmNlLCB0aGlzIGludmVzdG1lbnQgYWxpZ25zIHdpdGggeW91ciAke3BhcmFtZXRlcnMuaW52ZXN0bWVudEhvcml6b259IGludmVzdG1lbnQgaG9yaXpvbi4gVGhlIGFuYWx5c2lzIHNob3dzIHN0cm9uZyBmdW5kYW1lbnRhbHMgYW5kIHBvc2l0aXZlIG1hcmtldCBzZW50aW1lbnQuYCxcbiAgICAgIGNvbmZpZGVuY2VTY29yZTogTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogMzApICsgNzAsIC8vIDcwLTEwMFxuICAgICAgdGltZUhvcml6b246IHBhcmFtZXRlcnMuaW52ZXN0bWVudEhvcml6b24sXG4gICAgICBwb3RlbnRpYWxSZXR1cm46IHtcbiAgICAgICAgYmVzdDogTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogMjApICsgMTUsXG4gICAgICAgIGV4cGVjdGVkOiBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiAxNSkgKyA4LFxuICAgICAgICB3b3JzdDogTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogMTApIC0gNVxuICAgICAgfSxcbiAgICAgIHJpc2tGYWN0b3JzOiBbXG4gICAgICAgIHtcbiAgICAgICAgICBsZXZlbDogJ21lZGl1bScsXG4gICAgICAgICAgZGVzY3JpcHRpb246ICdNYXJrZXQgdm9sYXRpbGl0eSBtYXkgaW1wYWN0IHNob3J0LXRlcm0gcGVyZm9ybWFuY2UnXG4gICAgICAgIH0sXG4gICAgICAgIHtcbiAgICAgICAgICBsZXZlbDogJ2xvdycsXG4gICAgICAgICAgZGVzY3JpcHRpb246ICdSZWd1bGF0b3J5IGNoYW5nZXMgaW4gdGhlIHNlY3RvcidcbiAgICAgICAgfVxuICAgICAgXSxcbiAgICAgIHN1cHBvcnRpbmdEYXRhOiBbXG4gICAgICAgIHtcbiAgICAgICAgICBzb3VyY2U6ICdNYXJrZXQgQW5hbHlzaXMnLFxuICAgICAgICAgIHR5cGU6ICdmdW5kYW1lbnRhbCcsXG4gICAgICAgICAgdmFsdWU6ICdTdHJvbmcgZWFybmluZ3MgZ3Jvd3RoJyxcbiAgICAgICAgICB0aW1lc3RhbXA6IG5ldyBEYXRlKCksXG4gICAgICAgICAgcmVsaWFiaWxpdHk6IDAuOVxuICAgICAgICB9XG4gICAgICBdLFxuICAgICAgY29tcGxpYW5jZUNvbnNpZGVyYXRpb25zOiBbXVxuICAgIH0pO1xuICB9XG5cbiAgcmV0dXJuIHtcbiAgICBpbnZlc3RtZW50SWRlYXMsXG4gICAgcHJvY2Vzc2luZ01ldHJpY3M6IHtcbiAgICAgIHRvdGFsUHJvY2Vzc2luZ1RpbWU6IDMwMDAwLFxuICAgICAgbW9kZWxFeGVjdXRpb25UaW1lOiAxNTAwMCxcbiAgICAgIGRhdGFSZXRyaWV2YWxUaW1lOiA4MDAwLFxuICAgICAgdmFsaWRhdGlvblRpbWU6IDIwMDBcbiAgICB9LFxuICAgIGdlbmVyYXRlZEF0OiBuZXcgRGF0ZSgpLFxuICAgIG1ldGFkYXRhOiB7XG4gICAgICBnZW5lcmF0aW9uTWV0aG9kOiAnbXVsdGktYWdlbnQnLFxuICAgICAgcmVzZWFyY2hTb3VyY2VzOiBbJ01hcmtldCBEYXRhJywgJ0ZpbmFuY2lhbCBSZXBvcnRzJywgJ05ld3MgQW5hbHlzaXMnXSxcbiAgICAgIG1hcmtldERhdGFUaW1lc3RhbXA6IG5ldyBEYXRlKCksXG4gICAgICBjb21wbGlhbmNlVmVyc2lvbjogJzEuMC4wJ1xuICAgIH1cbiAgfTtcbn1cblxuLy8gSGVhbHRoIGNoZWNrXG5hcHAuZ2V0KCcvaGVhbHRoJywgKHJlcSwgcmVzKSA9PiB7XG4gIHJlcy5qc29uKHsgc3RhdHVzOiAnb2snLCBzZXJ2aWNlOiAnSW52ZXN0bWVudCBBSSBBZ2VudCBUZXN0IFNlcnZlcicgfSk7XG59KTtcblxuLy8gU3RhcnQgc2VydmVyXG5hcHAubGlzdGVuKFBPUlQsICgpID0+IHtcbiAgY29uc29sZS5sb2coYEludmVzdG1lbnQgQUkgQWdlbnQgdGVzdCBzZXJ2ZXIgcnVubmluZyBvbiBwb3J0ICR7UE9SVH1gKTtcbiAgY29uc29sZS5sb2coYEZyb250ZW5kIGF2YWlsYWJsZSBhdDogaHR0cDovL2xvY2FsaG9zdDoke1BPUlR9YCk7XG4gIGNvbnNvbGUubG9nKGBBUEkgZG9jdW1lbnRhdGlvbiBhdDogaHR0cDovL2xvY2FsaG9zdDoke1BPUlR9L2FwaS1kb2NzYCk7XG59KTtcblxuZXhwb3J0IGRlZmF1bHQgYXBwOyJdfQ==