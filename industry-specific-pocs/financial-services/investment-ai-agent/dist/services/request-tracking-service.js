"use strict";
/**
 * Request Tracking Service
 * Tracks investment idea generation requests and their progress
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.RequestTrackingService = void 0;
class RequestTrackingService {
    constructor() {
        this.trackingData = new Map();
        this.TRACKING_RETENTION_HOURS = 72; // Keep tracking data for 72 hours
    }
    /**
     * Start tracking a new request
     */
    async startTracking(requestId, userId) {
        const tracking = {
            requestId,
            userId: userId || '',
            status: 'submitted',
            progress: {
                percentage: 0,
                currentPhase: 'validation',
                completedSteps: [],
                totalSteps: 12,
                startTime: new Date()
            },
            currentStep: 'parameter-validation',
            results: undefined,
            errors: [],
            warnings: [],
            lastUpdated: new Date(),
            processingHistory: [{
                    step: 'parameter-validation',
                    status: 'started',
                    timestamp: new Date()
                }]
        };
        this.trackingData.set(requestId, tracking);
        // Schedule cleanup
        this.scheduleCleanup(requestId);
    }
    /**
     * Update request status
     */
    async updateStatus(requestId, status) {
        const tracking = this.trackingData.get(requestId);
        if (!tracking) {
            throw new Error(`Request tracking not found: ${requestId}`);
        }
        tracking.status = status;
        tracking.lastUpdated = new Date();
        // Update progress based on status
        switch (status) {
            case 'validated':
                tracking.progress.percentage = 10;
                tracking.progress.currentPhase = 'planning';
                break;
            case 'queued':
                tracking.progress.percentage = 15;
                break;
            case 'processing':
                tracking.progress.percentage = 20;
                tracking.progress.currentPhase = 'research';
                break;
            case 'completed':
                tracking.progress.percentage = 100;
                tracking.progress.currentPhase = 'finalization';
                tracking.progress.estimatedEndTime = new Date();
                break;
            case 'failed':
                tracking.progress.currentPhase = 'finalization';
                break;
            case 'cancelled':
                tracking.progress.currentPhase = 'finalization';
                break;
        }
        this.trackingData.set(requestId, tracking);
    }
    /**
     * Update current processing step
     */
    async updateStep(requestId, step, status, details, agentId, modelUsed) {
        const tracking = this.trackingData.get(requestId);
        if (!tracking) {
            throw new Error(`Request tracking not found: ${requestId}`);
        }
        const historyEntry = {
            step,
            status,
            timestamp: new Date(),
            details,
            agentId,
            modelUsed
        };
        // Calculate duration if completing a step
        if (status === 'completed' || status === 'failed') {
            const startEntry = tracking.processingHistory
                .reverse()
                .find(entry => entry.step === step && entry.status === 'started');
            if (startEntry) {
                historyEntry.duration = new Date().getTime() - startEntry.timestamp.getTime();
            }
            tracking.processingHistory.reverse(); // Restore original order
        }
        tracking.processingHistory.push(historyEntry);
        tracking.currentStep = step;
        tracking.lastUpdated = new Date();
        // Update progress percentage and phase
        this.updateProgressFromStep(tracking, step, status);
        // Mark step as completed if successful
        if (status === 'completed' && !tracking.progress.completedSteps.includes(step)) {
            tracking.progress.completedSteps.push(step);
        }
        this.trackingData.set(requestId, tracking);
    }
    /**
     * Add error to tracking
     */
    async addError(requestId, error) {
        const tracking = this.trackingData.get(requestId);
        if (!tracking) {
            throw new Error(`Request tracking not found: ${requestId}`);
        }
        const errorWithTimestamp = {
            ...error,
            timestamp: new Date()
        };
        tracking.errors = tracking.errors || [];
        tracking.errors.push(errorWithTimestamp);
        tracking.lastUpdated = new Date();
        // Update status to failed if critical error
        if (error.severity === 'critical') {
            tracking.status = 'failed';
        }
        this.trackingData.set(requestId, tracking);
    }
    /**
     * Add warning to tracking
     */
    async addWarning(requestId, warning) {
        const tracking = this.trackingData.get(requestId);
        if (!tracking) {
            throw new Error(`Request tracking not found: ${requestId}`);
        }
        const warningWithTimestamp = {
            ...warning,
            timestamp: new Date()
        };
        tracking.warnings = tracking.warnings || [];
        tracking.warnings.push(warningWithTimestamp);
        tracking.lastUpdated = new Date();
        this.trackingData.set(requestId, tracking);
    }
    /**
     * Get request status for a user
     */
    async getRequestStatus(requestId, userId) {
        const tracking = this.trackingData.get(requestId);
        if (!tracking) {
            return null;
        }
        // Verify user has access to this request
        if (tracking.userId && tracking.userId !== userId) {
            return null;
        }
        // Calculate estimated time remaining
        if (tracking.status === 'processing' && tracking.progress.percentage > 0) {
            const elapsed = new Date().getTime() - tracking.progress.startTime.getTime();
            const estimatedTotal = (elapsed / tracking.progress.percentage) * 100;
            const remaining = Math.max(0, estimatedTotal - elapsed);
            tracking.progress.estimatedEndTime = new Date(Date.now() + remaining);
        }
        return tracking;
    }
    /**
     * Set request results
     */
    async setResults(requestId, results) {
        const tracking = this.trackingData.get(requestId);
        if (!tracking) {
            throw new Error(`Request tracking not found: ${requestId}`);
        }
        tracking.results = results;
        tracking.lastUpdated = new Date();
        this.trackingData.set(requestId, tracking);
    }
    /**
     * Get all active requests for monitoring
     */
    async getActiveRequests() {
        const activeStatuses = ['submitted', 'validated', 'queued', 'processing'];
        return Array.from(this.trackingData.values())
            .filter(tracking => activeStatuses.includes(tracking.status));
    }
    /**
     * Get request statistics
     */
    async getRequestStatistics(timeframe = 'day') {
        const now = new Date();
        let cutoffTime;
        switch (timeframe) {
            case 'hour':
                cutoffTime = new Date(now.getTime() - 60 * 60 * 1000);
                break;
            case 'day':
                cutoffTime = new Date(now.getTime() - 24 * 60 * 60 * 1000);
                break;
            case 'week':
                cutoffTime = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                break;
        }
        const recentRequests = Array.from(this.trackingData.values())
            .filter(tracking => tracking.progress.startTime >= cutoffTime);
        const total = recentRequests.length;
        const completed = recentRequests.filter(r => r.status === 'completed').length;
        const failed = recentRequests.filter(r => r.status === 'failed').length;
        const cancelled = recentRequests.filter(r => r.status === 'cancelled').length;
        const processing = recentRequests.filter(r => r.status === 'processing').length;
        // Calculate average processing time for completed requests
        const completedRequests = recentRequests.filter(r => r.status === 'completed' && r.progress.estimatedEndTime);
        const totalProcessingTime = completedRequests.reduce((sum, request) => {
            const processingTime = request.progress.estimatedEndTime.getTime() -
                request.progress.startTime.getTime();
            return sum + processingTime;
        }, 0);
        const averageProcessingTime = completedRequests.length > 0
            ? totalProcessingTime / completedRequests.length
            : 0;
        const errorRate = total > 0 ? (failed / total) * 100 : 0;
        return {
            total,
            completed,
            failed,
            cancelled,
            processing,
            averageProcessingTime,
            errorRate
        };
    }
    /**
     * Clean up old tracking data
     */
    async cleanup() {
        const cutoffTime = new Date(Date.now() - this.TRACKING_RETENTION_HOURS * 60 * 60 * 1000);
        for (const [requestId, tracking] of this.trackingData.entries()) {
            if (tracking.lastUpdated < cutoffTime) {
                this.trackingData.delete(requestId);
            }
        }
    }
    /**
     * Update progress based on current step
     */
    updateProgressFromStep(tracking, step, status) {
        if (status !== 'completed')
            return;
        const stepProgressMap = {
            'parameter-validation': { percentage: 10, phase: 'validation' },
            'user-authentication': { percentage: 15, phase: 'validation' },
            'request-queuing': { percentage: 20, phase: 'planning' },
            'research-planning': { percentage: 25, phase: 'planning' },
            'data-collection': { percentage: 35, phase: 'research' },
            'market-analysis': { percentage: 50, phase: 'analysis' },
            'idea-generation': { percentage: 65, phase: 'analysis' },
            'compliance-check': { percentage: 75, phase: 'compliance' },
            'risk-assessment': { percentage: 80, phase: 'compliance' },
            'result-synthesis': { percentage: 90, phase: 'synthesis' },
            'output-formatting': { percentage: 95, phase: 'synthesis' },
            'quality-assurance': { percentage: 100, phase: 'finalization' }
        };
        const stepInfo = stepProgressMap[step];
        if (stepInfo) {
            tracking.progress.percentage = stepInfo.percentage;
            tracking.progress.currentPhase = stepInfo.phase;
        }
    }
    /**
     * Schedule cleanup for a specific request
     */
    scheduleCleanup(requestId) {
        setTimeout(() => {
            const tracking = this.trackingData.get(requestId);
            if (tracking && ['completed', 'failed', 'cancelled'].includes(tracking.status)) {
                this.trackingData.delete(requestId);
            }
        }, this.TRACKING_RETENTION_HOURS * 60 * 60 * 1000);
    }
}
exports.RequestTrackingService = RequestTrackingService;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVxdWVzdC10cmFja2luZy1zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL3NlcnZpY2VzL3JlcXVlc3QtdHJhY2tpbmctc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUE7OztHQUdHOzs7QUFhSCxNQUFhLHNCQUFzQjtJQUFuQztRQUNVLGlCQUFZLEdBQWlDLElBQUksR0FBRyxFQUFFLENBQUM7UUFDOUMsNkJBQXdCLEdBQUcsRUFBRSxDQUFDLENBQUMsa0NBQWtDO0lBa1dwRixDQUFDO0lBaFdDOztPQUVHO0lBQ0ksS0FBSyxDQUFDLGFBQWEsQ0FBQyxTQUFpQixFQUFFLE1BQWU7UUFDM0QsTUFBTSxRQUFRLEdBQW9CO1lBQ2hDLFNBQVM7WUFDVCxNQUFNLEVBQUUsTUFBTSxJQUFJLEVBQUU7WUFDcEIsTUFBTSxFQUFFLFdBQVc7WUFDbkIsUUFBUSxFQUFFO2dCQUNSLFVBQVUsRUFBRSxDQUFDO2dCQUNiLFlBQVksRUFBRSxZQUFZO2dCQUMxQixjQUFjLEVBQUUsRUFBRTtnQkFDbEIsVUFBVSxFQUFFLEVBQUU7Z0JBQ2QsU0FBUyxFQUFFLElBQUksSUFBSSxFQUFFO2FBQ3RCO1lBQ0QsV0FBVyxFQUFFLHNCQUFzQjtZQUNuQyxPQUFPLEVBQUUsU0FBUztZQUNsQixNQUFNLEVBQUUsRUFBRTtZQUNWLFFBQVEsRUFBRSxFQUFFO1lBQ1osV0FBVyxFQUFFLElBQUksSUFBSSxFQUFFO1lBQ3ZCLGlCQUFpQixFQUFFLENBQUM7b0JBQ2xCLElBQUksRUFBRSxzQkFBc0I7b0JBQzVCLE1BQU0sRUFBRSxTQUFTO29CQUNqQixTQUFTLEVBQUUsSUFBSSxJQUFJLEVBQUU7aUJBQ3RCLENBQUM7U0FDSCxDQUFDO1FBRUYsSUFBSSxDQUFDLFlBQVksQ0FBQyxHQUFHLENBQUMsU0FBUyxFQUFFLFFBQVEsQ0FBQyxDQUFDO1FBRTNDLG1CQUFtQjtRQUNuQixJQUFJLENBQUMsZUFBZSxDQUFDLFNBQVMsQ0FBQyxD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LEdBQUcsRUFBRTtZQUNkLE1BQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxZQUFZLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxDQUFDO1lBQ2xELElBQUksUUFBUSxJQUFJLENBQUMsV0FBVyxFQUFFLFFBQVEsRUFBRSxXQUFXLENBQUMsQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxFQUFFO2dCQUM5RSxJQUFJLENBQUMsWUFBWSxDQUFDLE1BQU0sQ0FBQyxTQUFTLENBQUMsQ0FBQzthQUNyQztRQUNILENBQUMsRUFBRSxJQUFJLENBQUMsd0JBQXdCLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxJQUFJLENBQUMsQ0FBQztJQUNyRCxDQUFDO0NBQ0Y7QUFwV0Qsd0RBb1dDIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBSZXF1ZXN0IFRyYWNraW5nIFNlcnZpY2VcbiAqIFRyYWNrcyBpbnZlc3RtZW50IGlkZWEgZ2VuZXJhdGlvbiByZXF1ZXN0cyBhbmQgdGhlaXIgcHJvZ3Jlc3NcbiAqL1xuXG5pbXBvcnQgeyBcbiAgUmVxdWVzdFRyYWNraW5nLCBcbiAgUmVxdWVzdFByb2dyZXNzLCBcbiAgUHJvY2Vzc2luZ1N0ZXAsIFxuICBQcm9jZXNzaW5nUGhhc2UsXG4gIFByb2Nlc3NpbmdIaXN0b3J5RW50cnksXG4gIFJlcXVlc3RFcnJvcixcbiAgUmVxdWVzdFdhcm5pbmcsXG4gIFJlcXVlc3RTdGF0dXNcbn0gZnJvbSAnLi4vbW9kZWxzL2ludmVzdG1lbnQtaWRlYS1yZXF1ZXN0JztcblxuZXhwb3J0IGNsYXNzIFJlcXVlc3RUcmFja2luZ1NlcnZpY2Uge1xuICBwcml2YXRlIHRyYWNraW5nRGF0YTogTWFwPHN0cmluZywgUmVxdWVzdFRyYWNraW5nPiA9IG5ldyBNYXAoKTtcbiAgcHJpdmF0ZSByZWFkb25seSBUUkFDS0lOR19SRVRFTlRJT05fSE9VUlMgPSA3MjsgLy8gS2VlcCB0cmFja2luZyBkYXRhIGZvciA3MiBob3Vyc1xuXG4gIC8qKlxuICAgKiBTdGFydCB0cmFja2luZyBhIG5ldyByZXF1ZXN0XG4gICAqL1xuICBwdWJsaWMgYXN5bmMgc3RhcnRUcmFja2luZyhyZXF1ZXN0SWQ6IHN0cmluZywgdXNlcklkPzogc3RyaW5nKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgY29uc3QgdHJhY2tpbmc6IFJlcXVlc3RUcmFja2luZyA9IHtcbiAgICAgIHJlcXVlc3RJZCxcbiAgICAgIHVzZXJJZDogdXNlcklkIHx8ICcnLFxuICAgICAgc3RhdHVzOiAnc3VibWl0dGVkJyxcbiAgICAgIHByb2dyZXNzOiB7XG4gICAgICAgIHBlcmNlbnRhZ2U6IDAsXG4gICAgICAgIGN1cnJlbnRQaGFzZTogJ3ZhbGlkYXRpb24nLFxuICAgICAgICBjb21wbGV0ZWRTdGVwczogW10sXG4gICAgICAgIHRvdGFsU3RlcHM6IDEyLCAvLyBUb3RhbCBudW1iZXIgb2YgcHJvY2Vzc2luZyBzdGVwc1xuICAgICAgICBzdGFydFRpbWU6IG5ldyBEYXRlKClcbiAgICAgIH0sXG4gICAgICBjdXJyZW50U3RlcDogJ3BhcmFtZXRlci12YWxpZGF0aW9uJyxcbiAgICAgIHJlc3VsdHM6IHVuZGVmaW5lZCxcbiAgICAgIGVycm9yczogW10sXG4gICAgICB3YXJuaW5nczogW10sXG4gICAgICBsYXN0VXBkYXRlZDogbmV3IERhdGUoKSxcbiAgICAgIHByb2Nlc3NpbmdIaXN0b3J5OiBbe1xuICAgICAgICBzdGVwOiAncGFyYW1ldGVyLXZhbGlkYXRpb24nLFxuICAgICAgICBzdGF0dXM6ICdzdGFydGVkJyxcbiAgICAgICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpXG4gICAgICB9XVxuICAgIH07XG5cbiAgICB0aGlzLnRyYWNraW5nRGF0YS5zZXQocmVxdWVzdElkLCB0cmFja2luZyk7XG4gICAgXG4gICAgLy8gU2NoZWR1bGUgY2xlYW51cFxuICAgIHRoaXMuc2NoZWR1bGVDbGVhbnVwKHJlcXVlc3RJZCk7XG4gIH1cblxuICAvKipcbiAgICogVXBkYXRlIHJlcXVlc3Qgc3RhdHVzXG4gICAqL1xuICBwdWJsaWMgYXN5bmMgdXBkYXRlU3RhdHVzKHJlcXVlc3RJZDogc3RyaW5nLCBzdGF0dXM6IFJlcXVlc3RTdGF0dXMpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBjb25zdCB0cmFja2luZyA9IHRoaXMudHJhY2tpbmdEYXRhLmdldChyZXF1ZXN0SWQpO1xuICAgIGlmICghdHJhY2tpbmcpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgUmVxdWVzdCB0cmFja2luZyBub3QgZm91bmQ6ICR7cmVxdWVzdElkfWApO1xuICAgIH1cblxuICAgIHRyYWNraW5nLnN0YXR1cyA9IHN0YXR1cztcbiAgICB0cmFja2luZy5sYXN0VXBkYXRlZCA9IG5ldyBEYXRlKCk7XG5cbiAgICAvLyBVcGRhdGUgcHJvZ3Jlc3MgYmFzZWQgb24gc3RhdHVzXG4gICAgc3dpdGNoIChzdGF0dXMpIHtcbiAgICAgIGNhc2UgJ3ZhbGlkYXRlZCc6XG4gICAgICAgIHRyYWNraW5nLnByb2dyZXNzLnBlcmNlbnRhZ2UgPSAxMDtcbiAgICAgICAgdHJhY2tpbmcucHJvZ3Jlc3MuY3VycmVudFBoYXNlID0gJ3BsYW5uaW5nJztcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlICdxdWV1ZWQnOlxuICAgICAgICB0cmFja2luZy5wcm9ncmVzcy5wZXJjZW50YWdlID0gMTU7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSAncHJvY2Vzc2luZyc6XG4gICAgICAgIHRyYWNraW5nLnByb2dyZXNzLnBlcmNlbnRhZ2UgPSAyMDtcbiAgICAgICAgdHJhY2tpbmcucHJvZ3Jlc3MuY3VycmVudFBoYXNlID0gJ3Jlc2VhcmNoJztcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlICdjb21wbGV0ZWQnOlxuICAgICAgICB0cmFja2luZy5wcm9ncmVzcy5wZXJjZW50YWdlID0gMTAwO1xuICAgICAgICB0cmFja2luZy5wcm9ncmVzcy5jdXJyZW50UGhhc2UgPSAnZmluYWxpemF0aW9uJztcbiAgICAgICAgdHJhY2tpbmcucHJvZ3Jlc3MuZXN0aW1hdGVkRW5kVGltZSA9IG5ldyBEYXRlKCk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSAnZmFpbGVkJzpcbiAgICAgICAgdHJhY2tpbmcucHJvZ3Jlc3MuY3VycmVudFBoYXNlID0gJ2ZpbmFsaXphdGlvbic7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSAnY2FuY2VsbGVkJzpcbiAgICAgICAgdHJhY2tpbmcucHJvZ3Jlc3MuY3VycmVudFBoYXNlID0gJ2ZpbmFsaXphdGlvbic7XG4gICAgICAgIGJyZWFrO1xuICAgIH1cblxuICAgIHRoaXMudHJhY2tpbmdEYXRhLnNldChyZXF1ZXN0SWQsIHRyYWNraW5nKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBVcGRhdGUgY3VycmVudCBwcm9jZXNzaW5nIHN0ZXBcbiAgICovXG4gIHB1YmxpYyBhc3luYyB1cGRhdGVTdGVwKFxuICAgIHJlcXVlc3RJZDogc3RyaW5nLCBcbiAgICBzdGVwOiBQcm9jZXNzaW5nU3RlcCwgXG4gICAgc3RhdHVzOiAnc3RhcnRlZCcgfCAnY29tcGxldGVkJyB8ICdmYWlsZWQnIHwgJ3NraXBwZWQnLFxuICAgIGRldGFpbHM/OiBzdHJpbmcsXG4gICAgYWdlbnRJZD86IHN0cmluZyxcbiAgICBtb2RlbFVzZWQ/OiBzdHJpbmdcbiAgKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgY29uc3QgdHJhY2tpbmcgPSB0aGlzLnRyYWNraW5nRGF0YS5nZXQocmVxdWVzdElkKTtcbiAgICBpZiAoIXRyYWNraW5nKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYFJlcXVlc3QgdHJhY2tpbmcgbm90IGZvdW5kOiAke3JlcXVlc3RJZH1gKTtcbiAgICB9XG5cbiAgICBjb25zdCBoaXN0b3J5RW50cnk6IFByb2Nlc3NpbmdIaXN0b3J5RW50cnkgPSB7XG4gICAgICBzdGVwLFxuICAgICAgc3RhdHVzLFxuICAgICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLFxuICAgICAgZGV0YWlscyxcbiAgICAgIGFnZW50SWQsXG4gICAgICBtb2RlbFVzZWRcbiAgICB9O1xuXG4gICAgLy8gQ2FsY3VsYXRlIGR1cmF0aW9uIGlmIGNvbXBsZXRpbmcgYSBzdGVwXG4gICAgaWYgKHN0YXR1cyA9PT0gJ2NvbXBsZXRlZCcgfHwgc3RhdHVzID09PSAnZmFpbGVkJykge1xuICAgICAgY29uc3Qgc3RhcnRFbnRyeSA9IHRyYWNraW5nLnByb2Nlc3NpbmdIaXN0b3J5XG4gICAgICAgIC5yZXZlcnNlKClcbiAgICAgICAgLmZpbmQoZW50cnkgPT4gZW50cnkuc3RlcCA9PT0gc3RlcCAmJiBlbnRyeS5zdGF0dXMgPT09ICdzdGFydGVkJyk7XG4gICAgICBcbiAgICAgIGlmIChzdGFydEVudHJ5KSB7XG4gICAgICAgIGhpc3RvcnlFbnRyeS5kdXJhdGlvbiA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpIC0gc3RhcnRFbnRyeS50aW1lc3RhbXAuZ2V0VGltZSgpO1xuICAgICAgfVxuICAgICAgXG4gICAgICB0cmFja2luZy5wcm9jZXNzaW5nSGlzdG9yeS5yZXZlcnNlKCk7IC8vIFJlc3RvcmUgb3JpZ2luYWwgb3JkZXJcbiAgICB9XG5cbiAgICB0cmFja2luZy5wcm9jZXNzaW5nSGlzdG9yeS5wdXNoKGhpc3RvcnlFbnRyeSk7XG4gICAgdHJhY2tpbmcuY3VycmVudFN0ZXAgPSBzdGVwO1xuICAgIHRyYWNraW5nLmxhc3RVcGRhdGVkID0gbmV3IERhdGUoKTtcblxuICAgIC8vIFVwZGF0ZSBwcm9ncmVzcyBwZXJjZW50YWdlIGFuZCBwaGFzZVxuICAgIHRoaXMudXBkYXRlUHJvZ3Jlc3NGcm9tU3RlcCh0cmFja2luZywgc3RlcCwgc3RhdHVzKTtcblxuICAgIC8vIE1hcmsgc3RlcCBhcyBjb21wbGV0ZWQgaWYgc3VjY2Vzc2Z1bFxuICAgIGlmIChzdGF0dXMgPT09ICdjb21wbGV0ZWQnICYmICF0cmFja2luZy5wcm9ncmVzcy5jb21wbGV0ZWRTdGVwcy5pbmNsdWRlcyhzdGVwKSkge1xuICAgICAgdHJhY2tpbmcucHJvZ3Jlc3MuY29tcGxldGVkU3RlcHMucHVzaChzdGVwKTtcbiAgICB9XG5cbiAgICB0aGlzLnRyYWNraW5nRGF0YS5zZXQocmVxdWVzdElkLCB0cmFja2luZyk7XG4gIH1cblxuICAvKipcbiAgICogQWRkIGVycm9yIHRvIHRyYWNraW5nXG4gICAqL1xuICBwdWJsaWMgYXN5bmMgYWRkRXJyb3IoXG4gICAgcmVxdWVzdElkOiBzdHJpbmcsIFxuICAgIGVycm9yOiBPbWl0PFJlcXVlc3RFcnJvciwgJ3RpbWVzdGFtcCc+XG4gICk6IFByb21pc2U8dm9pZD4ge1xuICAgIGNvbnN0IHRyYWNraW5nID0gdGhpcy50cmFja2luZ0RhdGEuZ2V0KHJlcXVlc3RJZCk7XG4gICAgaWYgKCF0cmFja2luZykge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBSZXF1ZXN0IHRyYWNraW5nIG5vdCBmb3VuZDogJHtyZXF1ZXN0SWR9YCk7XG4gICAgfVxuXG4gICAgY29uc3QgZXJyb3JXaXRoVGltZXN0YW1wOiBSZXF1ZXN0RXJyb3IgPSB7XG4gICAgICAuLi5lcnJvcixcbiAgICAgIHRpbWVzdGFtcDogbmV3IERhdGUoKVxuICAgIH07XG5cbiAgICB0cmFja2luZy5lcnJvcnMgPSB0cmFja2luZy5lcnJvcnMgfHwgW107XG4gICAgdHJhY2tpbmcuZXJyb3JzLnB1c2goZXJyb3JXaXRoVGltZXN0YW1wKTtcbiAgICB0cmFja2luZy5sYXN0VXBkYXRlZCA9IG5ldyBEYXRlKCk7XG5cbiAgICAvLyBVcGRhdGUgc3RhdHVzIHRvIGZhaWxlZCBpZiBjcml0aWNhbCBlcnJvclxuICAgIGlmIChlcnJvci5zZXZlcml0eSA9PT0gJ2NyaXRpY2FsJykge1xuICAgICAgdHJhY2tpbmcuc3RhdHVzID0gJ2ZhaWxlZCc7XG4gICAgfVxuXG4gICAgdGhpcy50cmFja2luZ0RhdGEuc2V0KHJlcXVlc3RJZCwgdHJhY2tpbmcpO1xuICB9XG5cbiAgLyoqXG4gICAqIEFkZCB3YXJuaW5nIHRvIHRyYWNraW5nXG4gICAqL1xuICBwdWJsaWMgYXN5bmMgYWRkV2FybmluZyhcbiAgICByZXF1ZXN0SWQ6IHN0cmluZywgXG4gICAgd2FybmluZzogT21pdDxSZXF1ZXN0V2FybmluZywgJ3RpbWVzdGFtcCc+XG4gICk6IFByb21pc2U8dm9pZD4ge1xuICAgIGNvbnN0IHRyYWNraW5nID0gdGhpcy50cmFja2luZ0RhdGEuZ2V0KHJlcXVlc3RJZCk7XG4gICAgaWYgKCF0cmFja2luZykge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBSZXF1ZXN0IHRyYWNraW5nIG5vdCBmb3VuZDogJHtyZXF1ZXN0SWR9YCk7XG4gICAgfVxuXG4gICAgY29uc3Qgd2FybmluZ1dpdGhUaW1lc3RhbXA6IFJlcXVlc3RXYXJuaW5nID0ge1xuICAgICAgLi4ud2FybmluZyxcbiAgICAgIHRpbWVzdGFtcDogbmV3IERhdGUoKVxuICAgIH07XG5cbiAgICB0cmFja2luZy53YXJuaW5ncyA9IHRyYWNraW5nLndhcm5pbmdzIHx8IFtdO1xuICAgIHRyYWNraW5nLndhcm5pbmdzLnB1c2god2FybmluZ1dpdGhUaW1lc3RhbXApO1xuICAgIHRyYWNraW5nLmxhc3RVcGRhdGVkID0gbmV3IERhdGUoKTtcblxuICAgIHRoaXMudHJhY2tpbmdEYXRhLnNldChyZXF1ZXN0SWQsIHRyYWNraW5nKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgcmVxdWVzdCBzdGF0dXMgZm9yIGEgdXNlclxuICAgKi9cbiAgcHVibGljIGFzeW5jIGdldFJlcXVlc3RTdGF0dXMocmVxdWVzdElkOiBzdHJpbmcsIHVzZXJJZDogc3RyaW5nKTogUHJvbWlzZTxSZXF1ZXN0VHJhY2tpbmcgfCBudWxsPiB7XG4gICAgY29uc3QgdHJhY2tpbmcgPSB0aGlzLnRyYWNraW5nRGF0YS5nZXQocmVxdWVzdElkKTtcbiAgICBcbiAgICBpZiAoIXRyYWNraW5nKSB7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG5cbiAgICAvLyBWZXJpZnkgdXNlciBoYXMgYWNjZXNzIHRvIHRoaXMgcmVxdWVzdFxuICAgIGlmICh0cmFja2luZy51c2VySWQgJiYgdHJhY2tpbmcudXNlcklkICE9PSB1c2VySWQpIHtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cblxuICAgIC8vIENhbGN1bGF0ZSBlc3RpbWF0ZWQgdGltZSByZW1haW5pbmdcbiAgICBpZiAodHJhY2tpbmcuc3RhdHVzID09PSAncHJvY2Vzc2luZycgJiYgdHJhY2tpbmcucHJvZ3Jlc3MucGVyY2VudGFnZSA+IDApIHtcbiAgICAgIGNvbnN0IGVsYXBzZWQgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKSAtIHRyYWNraW5nLnByb2dyZXNzLnN0YXJ0VGltZS5nZXRUaW1lKCk7XG4gICAgICBjb25zdCBlc3RpbWF0ZWRUb3RhbCA9IChlbGFwc2VkIC8gdHJhY2tpbmcucHJvZ3Jlc3MucGVyY2VudGFnZSkgKiAxMDA7XG4gICAgICBjb25zdCByZW1haW5pbmcgPSBNYXRoLm1heCgwLCBlc3RpbWF0ZWRUb3RhbCAtIGVsYXBzZWQpO1xuICAgICAgXG4gICAgICB0cmFja2luZy5wcm9ncmVzcy5lc3RpbWF0ZWRFbmRUaW1lID0gbmV3IERhdGUoRGF0ZS5ub3coKSArIHJlbWFpbmluZyk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHRyYWNraW5nO1xuICB9XG5cbiAgLyoqXG4gICAqIFNldCByZXF1ZXN0IHJlc3VsdHNcbiAgICovXG4gIHB1YmxpYyBhc3luYyBzZXRSZXN1bHRzKHJlcXVlc3RJZDogc3RyaW5nLCByZXN1bHRzOiBhbnkpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBjb25zdCB0cmFja2luZyA9IHRoaXMudHJhY2tpbmdEYXRhLmdldChyZXF1ZXN0SWQpO1xuICAgIGlmICghdHJhY2tpbmcpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgUmVxdWVzdCB0cmFja2luZyBub3QgZm91bmQ6ICR7cmVxdWVzdElkfWApO1xuICAgIH1cblxuICAgIHRyYWNraW5nLnJlc3VsdHMgPSByZXN1bHRzO1xuICAgIHRyYWNraW5nLmxhc3RVcGRhdGVkID0gbmV3IERhdGUoKTtcbiAgICBcbiAgICB0aGlzLnRyYWNraW5nRGF0YS5zZXQocmVxdWVzdElkLCB0cmFja2luZyk7XG4gIH1cblxuICAvKipcbiAgICogR2V0IGFsbCBhY3RpdmUgcmVxdWVzdHMgZm9yIG1vbml0b3JpbmdcbiAgICovXG4gIHB1YmxpYyBhc3luYyBnZXRBY3RpdmVSZXF1ZXN0cygpOiBQcm9taXNlPFJlcXVlc3RUcmFja2luZ1tdPiB7XG4gICAgY29uc3QgYWN0aXZlU3RhdHVzZXM6IFJlcXVlc3RTdGF0dXNbXSA9IFsnc3VibWl0dGVkJywgJ3ZhbGlkYXRlZCcsICdxdWV1ZWQnLCAncHJvY2Vzc2luZyddO1xuICAgIFxuICAgIHJldHVybiBBcnJheS5mcm9tKHRoaXMudHJhY2tpbmdEYXRhLnZhbHVlcygpKVxuICAgICAgLmZpbHRlcih0cmFja2luZyA9PiBhY3RpdmVTdGF0dXNlcy5pbmNsdWRlcyh0cmFja2luZy5zdGF0dXMpKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgcmVxdWVzdCBzdGF0aXN0aWNzXG4gICAqL1xuICBwdWJsaWMgYXN5bmMgZ2V0UmVxdWVzdFN0YXRpc3RpY3ModGltZWZyYW1lOiAnaG91cicgfCAnZGF5JyB8ICd3ZWVrJyA9ICdkYXknKTogUHJvbWlzZTx7XG4gICAgdG90YWw6IG51bWJlcjtcbiAgICBjb21wbGV0ZWQ6IG51bWJlcjtcbiAgICBmYWlsZWQ6IG51bWJlcjtcbiAgICBjYW5jZWxsZWQ6IG51bWJlcjtcbiAgICBwcm9jZXNzaW5nOiBudW1iZXI7XG4gICAgYXZlcmFnZVByb2Nlc3NpbmdUaW1lOiBudW1iZXI7XG4gICAgZXJyb3JSYXRlOiBudW1iZXI7XG4gIH0+IHtcbiAgICBjb25zdCBub3cgPSBuZXcgRGF0ZSgpO1xuICAgIGxldCBjdXRvZmZUaW1lOiBEYXRlO1xuXG4gICAgc3dpdGNoICh0aW1lZnJhbWUpIHtcbiAgICAgIGNhc2UgJ2hvdXInOlxuICAgICAgICBjdXRvZmZUaW1lID0gbmV3IERhdGUobm93LmdldFRpbWUoKSAtIDYwICogNjAgKiAxMDAwKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlICdkYXknOlxuICAgICAgICBjdXRvZmZUaW1lID0gbmV3IERhdGUobm93LmdldFRpbWUoKSAtIDI0ICogNjAgKiA2MCAqIDEwMDApO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgJ3dlZWsnOlxuICAgICAgICBjdXRvZmZUaW1lID0gbmV3IERhdGUobm93LmdldFRpbWUoKSAtIDcgKiAyNCAqIDYwICogNjAgKiAxMDAwKTtcbiAgICAgICAgYnJlYWs7XG4gICAgfVxuXG4gICAgY29uc3QgcmVjZW50UmVxdWVzdHMgPSBBcnJheS5mcm9tKHRoaXMudHJhY2tpbmdEYXRhLnZhbHVlcygpKVxuICAgICAgLmZpbHRlcih0cmFja2luZyA9PiB0cmFja2luZy5wcm9ncmVzcy5zdGFydFRpbWUgPj0gY3V0b2ZmVGltZSk7XG5cbiAgICBjb25zdCB0b3RhbCA9IHJlY2VudFJlcXVlc3RzLmxlbmd0aDtcbiAgICBjb25zdCBjb21wbGV0ZWQgPSByZWNlbnRSZXF1ZXN0cy5maWx0ZXIociA9PiByLnN0YXR1cyA9PT0gJ2NvbXBsZXRlZCcpLmxlbmd0aDtcbiAgICBjb25zdCBmYWlsZWQgPSByZWNlbnRSZXF1ZXN0cy5maWx0ZXIociA9PiByLnN0YXR1cyA9PT0gJ2ZhaWxlZCcpLmxlbmd0aDtcbiAgICBjb25zdCBjYW5jZWxsZWQgPSByZWNlbnRSZXF1ZXN0cy5maWx0ZXIociA9PiByLnN0YXR1cyA9PT0gJ2NhbmNlbGxlZCcpLmxlbmd0aDtcbiAgICBjb25zdCBwcm9jZXNzaW5nID0gcmVjZW50UmVxdWVzdHMuZmlsdGVyKHIgPT4gci5zdGF0dXMgPT09ICdwcm9jZXNzaW5nJykubGVuZ3RoO1xuXG4gICAgLy8gQ2FsY3VsYXRlIGF2ZXJhZ2UgcHJvY2Vzc2luZyB0aW1lIGZvciBjb21wbGV0ZWQgcmVxdWVzdHNcbiAgICBjb25zdCBjb21wbGV0ZWRSZXF1ZXN0cyA9IHJlY2VudFJlcXVlc3RzLmZpbHRlcihyID0+IFxuICAgICAgci5zdGF0dXMgPT09ICdjb21wbGV0ZWQnICYmIHIucHJvZ3Jlc3MuZXN0aW1hdGVkRW5kVGltZVxuICAgICk7XG4gICAgXG4gICAgY29uc3QgdG90YWxQcm9jZXNzaW5nVGltZSA9IGNvbXBsZXRlZFJlcXVlc3RzLnJlZHVjZSgoc3VtLCByZXF1ZXN0KSA9PiB7XG4gICAgICBjb25zdCBwcm9jZXNzaW5nVGltZSA9IHJlcXVlc3QucHJvZ3Jlc3MuZXN0aW1hdGVkRW5kVGltZSEuZ2V0VGltZSgpIC0gXG4gICAgICAgICAgICAgICAgICAgICAgICAgICByZXF1ZXN0LnByb2dyZXNzLnN0YXJ0VGltZS5nZXRUaW1lKCk7XG4gICAgICByZXR1cm4gc3VtICsgcHJvY2Vzc2luZ1RpbWU7XG4gICAgfSwgMCk7XG5cbiAgICBjb25zdCBhdmVyYWdlUHJvY2Vzc2luZ1RpbWUgPSBjb21wbGV0ZWRSZXF1ZXN0cy5sZW5ndGggPiAwIFxuICAgICAgPyB0b3RhbFByb2Nlc3NpbmdUaW1lIC8gY29tcGxldGVkUmVxdWVzdHMubGVuZ3RoIFxuICAgICAgOiAwO1xuXG4gICAgY29uc3QgZXJyb3JSYXRlID0gdG90YWwgPiAwID8gKGZhaWxlZCAvIHRvdGFsKSAqIDEwMCA6IDA7XG5cbiAgICByZXR1cm4ge1xuICAgICAgdG90YWwsXG4gICAgICBjb21wbGV0ZWQsXG4gICAgICBmYWlsZWQsXG4gICAgICBjYW5jZWxsZWQsXG4gICAgICBwcm9jZXNzaW5nLFxuICAgICAgYXZlcmFnZVByb2Nlc3NpbmdUaW1lLFxuICAgICAgZXJyb3JSYXRlXG4gICAgfTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDbGVhbiB1cCBvbGQgdHJhY2tpbmcgZGF0YVxuICAgKi9cbiAgcHVibGljIGFzeW5jIGNsZWFudXAoKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgY29uc3QgY3V0b2ZmVGltZSA9IG5ldyBEYXRlKERhdGUubm93KCkgLSB0aGlzLlRSQUNLSU5HX1JFVEVOVElPTl9IT1VSUyAqIDYwICogNjAgKiAxMDAwKTtcbiAgICBcbiAgICBmb3IgKGNvbnN0IFtyZXF1ZXN0SWQsIHRyYWNraW5nXSBvZiB0aGlzLnRyYWNraW5nRGF0YS5lbnRyaWVzKCkpIHtcbiAgICAgIGlmICh0cmFja2luZy5sYXN0VXBkYXRlZCA8IGN1dG9mZlRpbWUpIHtcbiAgICAgICAgdGhpcy50cmFja2luZ0RhdGEuZGVsZXRlKHJlcXVlc3RJZCk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFVwZGF0ZSBwcm9ncmVzcyBiYXNlZCBvbiBjdXJyZW50IHN0ZXBcbiAgICovXG4gIHByaXZhdGUgdXBkYXRlUHJvZ3Jlc3NGcm9tU3RlcChcbiAgICB0cmFja2luZzogUmVxdWVzdFRyYWNraW5nLCBcbiAgICBzdGVwOiBQcm9jZXNzaW5nU3RlcCwgXG4gICAgc3RhdHVzOiAnc3RhcnRlZCcgfCAnY29tcGxldGVkJyB8ICdmYWlsZWQnIHwgJ3NraXBwZWQnXG4gICk6IHZvaWQge1xuICAgIGlmIChzdGF0dXMgIT09ICdjb21wbGV0ZWQnKSByZXR1cm47XG5cbiAgICBjb25zdCBzdGVwUHJvZ3Jlc3NNYXA6IFJlY29yZDxQcm9jZXNzaW5nU3RlcCwgeyBwZXJjZW50YWdlOiBudW1iZXI7IHBoYXNlOiBQcm9jZXNzaW5nUGhhc2UgfT4gPSB7XG4gICAgICAncGFyYW1ldGVyLXZhbGlkYXRpb24nOiB7IHBlcmNlbnRhZ2U6IDEwLCBwaGFzZTogJ3ZhbGlkYXRpb24nIH0sXG4gICAgICAndXNlci1hdXRoZW50aWNhdGlvbic6IHsgcGVyY2VudGFnZTogMTUsIHBoYXNlOiAndmFsaWRhdGlvbicgfSxcbiAgICAgICdyZXF1ZXN0LXF1ZXVpbmcnOiB7IHBlcmNlbnRhZ2U6IDIwLCBwaGFzZTogJ3BsYW5uaW5nJyB9LFxuICAgICAgJ3Jlc2VhcmNoLXBsYW5uaW5nJzogeyBwZXJjZW50YWdlOiAyNSwgcGhhc2U6ICdwbGFubmluZycgfSxcbiAgICAgICdkYXRhLWNvbGxlY3Rpb24nOiB7IHBlcmNlbnRhZ2U6IDM1LCBwaGFzZTogJ3Jlc2VhcmNoJyB9LFxuICAgICAgJ21hcmtldC1hbmFseXNpcyc6IHsgcGVyY2VudGFnZTogNTAsIHBoYXNlOiAnYW5hbHlzaXMnIH0sXG4gICAgICAnaWRlYS1nZW5lcmF0aW9uJzogeyBwZXJjZW50YWdlOiA2NSwgcGhhc2U6ICdhbmFseXNpcycgfSxcbiAgICAgICdjb21wbGlhbmNlLWNoZWNrJzogeyBwZXJjZW50YWdlOiA3NSwgcGhhc2U6ICdjb21wbGlhbmNlJyB9LFxuICAgICAgJ3Jpc2stYXNzZXNzbWVudCc6IHsgcGVyY2VudGFnZTogODAsIHBoYXNlOiAnY29tcGxpYW5jZScgfSxcbiAgICAgICdyZXN1bHQtc3ludGhlc2lzJzogeyBwZXJjZW50YWdlOiA5MCwgcGhhc2U6ICdzeW50aGVzaXMnIH0sXG4gICAgICAnb3V0cHV0LWZvcm1hdHRpbmcnOiB7IHBlcmNlbnRhZ2U6IDk1LCBwaGFzZTogJ3N5bnRoZXNpcycgfSxcbiAgICAgICdxdWFsaXR5LWFzc3VyYW5jZSc6IHsgcGVyY2VudGFnZTogMTAwLCBwaGFzZTogJ2ZpbmFsaXphdGlvbicgfVxuICAgIH07XG5cbiAgICBjb25zdCBzdGVwSW5mbyA9IHN0ZXBQcm9ncmVzc01hcFtzdGVwXTtcbiAgICBpZiAoc3RlcEluZm8pIHtcbiAgICAgIHRyYWNraW5nLnByb2dyZXNzLnBlcmNlbnRhZ2UgPSBzdGVwSW5mby5wZXJjZW50YWdlO1xuICAgICAgdHJhY2tpbmcucHJvZ3Jlc3MuY3VycmVudFBoYXNlID0gc3RlcEluZm8ucGhhc2U7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFNjaGVkdWxlIGNsZWFudXAgZm9yIGEgc3BlY2lmaWMgcmVxdWVzdFxuICAgKi9cbiAgcHJpdmF0ZSBzY2hlZHVsZUNsZWFudXAocmVxdWVzdElkOiBzdHJpbmcpOiB2b2lkIHtcbiAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgIGNvbnN0IHRyYWNraW5nID0gdGhpcy50cmFja2luZ0RhdGEuZ2V0KHJlcXVlc3RJZCk7XG4gICAgICBpZiAodHJhY2tpbmcgJiYgWydjb21wbGV0ZWQnLCAnZmFpbGVkJywgJ2NhbmNlbGxlZCddLmluY2x1ZGVzKHRyYWNraW5nLnN0YXR1cykpIHtcbiAgICAgICAgdGhpcy50cmFja2luZ0RhdGEuZGVsZXRlKHJlcXVlc3RJZCk7XG4gICAgICB9XG4gICAgfSwgdGhpcy5UUkFDS0lOR19SRVRFTlRJT05fSE9VUlMgKiA2MCAqIDYwICogMTAwMCk7XG4gIH1cbn0iXX0=