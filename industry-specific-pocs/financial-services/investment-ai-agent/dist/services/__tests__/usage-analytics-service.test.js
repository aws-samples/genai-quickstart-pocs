"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const usage_analytics_service_1 = require("../monitoring/usage-analytics-service");
const aws_sdk_1 = require("aws-sdk");
// Mock AWS SDK
jest.mock('aws-sdk');
describe('UsageAnalyticsService', () => {
    let usageAnalyticsService;
    let mockCloudWatch;
    beforeEach(() => {
        mockCloudWatch = {
            getMetricStatistics: jest.fn().mockReturnValue({
                promise: jest.fn().mockResolvedValue({ Datapoints: [] })
            })
        };
        aws_sdk_1.CloudWatch.mockImplementation(() => mockCloudWatch);
        usageAnalyticsService = new usage_analytics_service_1.UsageAnalyticsService('us-east-1', 'TestNamespace', 'test');
    });
    afterEach(() => {
        jest.clearAllMocks();
    });
    describe('generateUsageReport', () => {
        it('should generate comprehensive usage report', async () => {
            const query = {
                startTime: new Date('2023-01-01T00:00:00Z'),
                endTime: new Date('2023-01-02T00:00:00Z'),
                granularity: 'hour'
            };
            // Mock CloudWatch responses
            mockCloudWatch.getMetricStatistics
                .mockReturnValueOnce({
                promise: jest.fn().mockResolvedValue({
                    Datapoints: [
                        { Sum: 100, Timestamp: new Date('2023-01-01T01:00:00Z') },
                        { Sum: 150, Timestamp: new Date('2023-01-01T02:00:00Z') }
                    ]
                })
            })
                .mockReturnValueOnce({
                promise: jest.fn().mockResolvedValue({
                    Datapoints: [
                        { Sum: 5, Timestamp: new Date('2023-01-01T01:00:00Z') }
                    ]
                })
            })
                .mockReturnValueOnce({
                promise: jest.fn().mockResolvedValue({
                    Datapoints: [
                        { Average: 1200, ExtendedStatistics: { p95: 2000, p99: 3000 } }
                    ]
                })
            })
                .mockReturnValue({
                promise: jest.fn().mockResolvedValue({
                    Datapoints: [
                        { Sum: 10, Average: 500 }
                    ]
                })
            });
            const report = await usageAnalyticsService.generateUsageReport(query);
            expect(report).toMatchObject({
                period: {
                    start: query.startTime,
                    end: query.endTime
                },
                totalRequests: 250,
                errorRate: expect.any(Number),
                averageResponseTime: expect.any(Number)
            });
            expect(report.modelUsage).toBeInstanceOf(Array);
            expect(report.topEndpoints).toBeInstanceOf(Array);
            expect(report.costAnalysis).toHaveProperty('totalCost');
            expect(report.userEngagement).toHaveProperty('activeUsers');
        });
        it('should handle CloudWatch errors gracefully', async () => {
            const query = {
                startTime: new Date('2023-01-01T00:00:00Z'),
                endTime: new Date('2023-01-02T00:00:00Z')
            };
            mockCloudWatch.getMetricStatistics.mockReturnValue({
                promise: jest.fn().mockRejectedValue(new Error('CloudWatch error'))
            });
            await expect(usageAnalyticsService.generateUsageReport(query)).rejects.toThrow('CloudWatch error');
        });
    });
    describe('exportUsageData', () => {
        it('should export usage data in JSON format', async () => {
            const query = {
                startTime: new Date('2023-01-01T00:00:00Z'),
                endTime: new Date('2023-01-02T00:00:00Z')
            };
            // Mock minimal CloudWatch responses
            mockCloudWatch.getMetricStatistics.mockReturnValue({
                promise: jest.fn().mockResolvedValue({
                    Datapoints: [{ Sum: 100 }]
                })
            });
            const result = await usageAnalyticsService.exportUsageData(query, 'json');
            expect(result).toContain('"totalRequests"');
            expect(result).toContain('"period"');
            expect(() => JSON.parse(result)).not.toThrow();
        });
        it('should export usage data in CSV format', async () => {
            const query = {
                startTime: new Date('2023-01-01T00:00:00Z'),
                endTime: new Date('2023-01-02T00:00:00Z')
            };
            // Mock minimal CloudWatch responses
            mockCloudWatch.getMetricStatistics.mockReturnValue({
                promise: jest.fn().mockResolvedValue({
                    Datapoints: [{ Sum: 100 }]
                })
            });
            const result = await usageAnalyticsService.exportUsageData(query, 'csv');
            expect(result).toContain('Metric,Value,Period Start,Period End');
            expect(result).toContain('Total Requests');
            expect(result).toContain('Error Rate');
        });
    });
    describe('private helper methods', () => {
        it('should convert granularity to seconds correctly', () => {
            // Access private method through type assertion for testing
            const service = usageAnalyticsService;
            expect(service.getPeriodInSeconds('hour')).toBe(3600);
            expect(service.getPeriodInSeconds('day')).toBe(86400);
            expect(service.getPeriodInSeconds('week')).toBe(604800);
            expect(service.getPeriodInSeconds('month')).toBe(2592000);
        });
    });
    describe('metric aggregation', () => {
        it('should handle empty datapoints gracefully', async () => {
            const query = {
                startTime: new Date('2023-01-01T00:00:00Z'),
                endTime: new Date('2023-01-02T00:00:00Z')
            };
            mockCloudWatch.getMetricStatistics.mockReturnValue({
                promise: jest.fn().mockResolvedValue({
                    Datapoints: []
                })
            });
            const report = await usageAnalyticsService.generateUsageReport(query);
            expect(report.totalRequests).toBe(0);
            expect(report.errorRate).toBe(0);
            expect(report.averageResponseTime).toBe(0);
        });
        it('should filter out models with zero usage', async () => {
            const query = {
                startTime: new Date('2023-01-01T00:00:00Z'),
                endTime: new Date('2023-01-02T00:00:00Z')
            };
            // Mock responses where some models have zero usage
            let callCount = 0;
            mockCloudWatch.getMetricStatistics.mockImplementation(() => {
                callCount++;
                const responses = [
                    { Datapoints: [{ Sum: 100 }] },
                    { Datapoints: [{ Sum: 5 }] },
                    { Datapoints: [{ Average: 1200 }] },
                    { Datapoints: [{ Sum: 50 }] },
                    { Datapoints: [{ Sum: 0 }] },
                    { Datapoints: [{ Sum: 0 }] },
                    { Datapoints: [{ Average: 1000 }] },
                    { Datapoints: [{ Sum: 45 }] },
                    { Datapoints: [{ Sum: 0 }] },
                    { Datapoints: [] }
                ];
                return {
                    promise: jest.fn().mockResolvedValue(responses[callCount - 1] || { Datapoints: [] })
                };
            });
            const report = await usageAnalyticsService.generateUsageReport(query);
            // Should only include models with usage > 0
            expect(report.modelUsage).toHaveLength(1);
            expect(report.modelUsage[0].totalCalls).toBe(50);
        });
    });
    describe('cost analysis', () => {
        it('should calculate projected monthly cost correctly', async () => {
            const query = {
                startTime: new Date('2023-01-01T00:00:00Z'),
                endTime: new Date('2023-01-02T00:00:00Z') // 1 day period
            };
            // Mock cost of $10 for 1 day
            let callCount = 0;
            mockCloudWatch.getMetricStatistics.mockImplementation(() => {
                callCount++;
                const responses = [
                    { Datapoints: [{ Sum: 100 }] },
                    { Datapoints: [{ Sum: 5 }] },
                    { Datapoints: [{ Average: 1200 }] },
                    { Datapoints: [{ Sum: 10 }] } // Total cost
                ];
                return {
                    promise: jest.fn().mockResolvedValue(responses[callCount - 1] || { Datapoints: [{ Sum: 10 }] })
                };
            });
            const report = await usageAnalyticsService.generateUsageReport(query);
            // Should project $300 for 30 days ($10 * 30)
            expect(report.costAnalysis.projectedMonthlyCost).toBe(300);
        });
    });
    describe('endpoint filtering', () => {
        it('should sort endpoints by request count', async () => {
            const query = {
                startTime: new Date('2023-01-01T00:00:00Z'),
                endTime: new Date('2023-01-02T00:00:00Z')
            };
            // Mock different request counts for different endpoints
            let callCount = 0;
            mockCloudWatch.getMetricStatistics.mockImplementation(() => {
                callCount++;
                if (callCount <= 3) {
                    return {
                        promise: jest.fn().mockResolvedValue({ Datapoints: [{ Sum: 100 }] })
                    };
                }
                // For endpoint stats, return different values
                const endpointCounts = [50, 100, 25, 75, 10]; // Different request counts
                const index = (callCount - 4) % 15; // 3 metrics per endpoint * 5 endpoints
                const metricIndex = Math.floor(index / 5);
                const endpointIndex = index % 5;
                if (metricIndex === 0) { // Request count
                    return {
                        promise: jest.fn().mockResolvedValue({ Datapoints: [{ Sum: endpointCounts[endpointIndex] }] })
                    };
                }
                else { // Response time or error count
                    return {
                        promise: jest.fn().mockResolvedValue({ Datapoints: [{ Average: 1000, Sum: 1 }] })
                    };
                }
            });
            const report = await usageAnalyticsService.generateUsageReport(query);
            // Should be sorted by request count (descending)
            expect(report.topEndpoints.length).toBeGreaterThan(0);
            for (let i = 1; i < report.topEndpoints.length; i++) {
                expect(report.topEndpoints[i - 1].requestCount).toBeGreaterThanOrEqual(report.topEndpoints[i].requestCount);
            }
        });
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXNhZ2UtYW5hbHl0aWNzLXNlcnZpY2UudGVzdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9zZXJ2aWNlcy9fX3Rlc3RzX18vdXNhZ2UtYW5hbHl0aWNzLXNlcnZpY2UudGVzdC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLG1GQUE4RjtBQUM5RixxQ0FBcUM7QUFFckMsZUFBZTtBQUNmLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUM7QUFFckIsUUFBUSxDQUFDLHVCQUF1QixFQUFFLEdBQUcsRUFBRTtJQUNyQyxJQUFJLHFCQUE0QyxDQUFDO0lBQ2pELElBQUksY0FBdUMsQ0FBQztJQUU1QyxVQUFVLENBQUMsR0FBRyxFQUFFO1FBQ2QsY0FBYyxHQUFHO1lBQ2YsbUJBQW1CLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDLGVBQWUsQ0FBQztnQkFDN0MsT0FBTyxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQyxpQkFBaUIsQ0FBQyxFQUFFLFVBQVUsRUFBRSxFQUFFLEVBQUUsQ0FBQzthQUN6RCxDQUFDO1NBQ0ksQ0FBQztRQUVSLG9CQUFrRCxDQUFDLGtCQUFrQixDQUFDLEdBQUcsRUFBRSxDQUFDLGNBQWMsQ0FBQyxDQUFDO1FBRTdGLHFCQUFxQixHQUFHLElBQUksK0NBQXFCLENBQUMsV0FBVyxFQUFFLGVBQWUsRUFBRSxNQUFNLENBQUMsQ0FBQztJQUMxRixDQUFDLENBQUMsQ0FBQztJQUVILFNBQVMsQ0FBQyxHQUFHLEVBQUU7UUFDYixJQUFJLENBQUMsYUFBYSxFQUFFLENBQUM7SUFDdkIsQ0FBQyxDQUFDLENBQUM7SUFFSCxRQUFRLENBQUMscUJBQXFCLEVBQUUsR0FBRyxFQUFFO1FBQ25DLEVBQUUsQ0FBQyw0Q0FBNEMsRUFBRSxLQUFLLElBQUksRUFBRTtZQUMxRCxNQUFNLEtBQUssR0FBbUI7Z0JBQzVCLFNBQVMsRUFBRSxJQUFJLElBQUksQ0FBQyxzQkFBc0IsQ0FB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QUFDLENBQUMsQ0FBQztZQUN0RCxLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsTUFBTSxDQUFDLFlBQVksQ0FBQyxNQUFNLEVBQUUsQ0FBQyxFQUFFLEVBQUU7Z0JBQ25ELE1BQU0sQ0FBQyxNQUFNLENBQUMsWUFBWSxDQUFDLENBQUMsR0FBQyxDQUFDLENBQUMsQ0FBQyxZQUFZLENBQUMsQ0FBQyxzQkFBc0IsQ0FDbEUsTUFBTSxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUMsQ0FBQyxZQUFZLENBQ3BDLENBQUM7YUFDSDtRQUNILENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDLENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFVzYWdlQW5hbHl0aWNzU2VydmljZSwgQW5hbHl0aWNzUXVlcnkgfSBmcm9tICcuLi9tb25pdG9yaW5nL3VzYWdlLWFuYWx5dGljcy1zZXJ2aWNlJztcbmltcG9ydCB7IENsb3VkV2F0Y2ggfSBmcm9tICdhd3Mtc2RrJztcblxuLy8gTW9jayBBV1MgU0RLXG5qZXN0Lm1vY2soJ2F3cy1zZGsnKTtcblxuZGVzY3JpYmUoJ1VzYWdlQW5hbHl0aWNzU2VydmljZScsICgpID0+IHtcbiAgbGV0IHVzYWdlQW5hbHl0aWNzU2VydmljZTogVXNhZ2VBbmFseXRpY3NTZXJ2aWNlO1xuICBsZXQgbW9ja0Nsb3VkV2F0Y2g6IGplc3QuTW9ja2VkPENsb3VkV2F0Y2g+O1xuXG4gIGJlZm9yZUVhY2goKCkgPT4ge1xuICAgIG1vY2tDbG91ZFdhdGNoID0ge1xuICAgICAgZ2V0TWV0cmljU3RhdGlzdGljczogamVzdC5mbigpLm1vY2tSZXR1cm5WYWx1ZSh7XG4gICAgICAgIHByb21pc2U6IGplc3QuZm4oKS5tb2NrUmVzb2x2ZWRWYWx1ZSh7IERhdGFwb2ludHM6IFtdIH0pXG4gICAgICB9KVxuICAgIH0gYXMgYW55O1xuXG4gICAgKENsb3VkV2F0Y2ggYXMgamVzdC5Nb2NrZWRDbGFzczx0eXBlb2YgQ2xvdWRXYXRjaD4pLm1vY2tJbXBsZW1lbnRhdGlvbigoKSA9PiBtb2NrQ2xvdWRXYXRjaCk7XG4gICAgXG4gICAgdXNhZ2VBbmFseXRpY3NTZXJ2aWNlID0gbmV3IFVzYWdlQW5hbHl0aWNzU2VydmljZSgndXMtZWFzdC0xJywgJ1Rlc3ROYW1lc3BhY2UnLCAndGVzdCcpO1xuICB9KTtcblxuICBhZnRlckVhY2goKCkgPT4ge1xuICAgIGplc3QuY2xlYXJBbGxNb2NrcygpO1xuICB9KTtcblxuICBkZXNjcmliZSgnZ2VuZXJhdGVVc2FnZVJlcG9ydCcsICgpID0+IHtcbiAgICBpdCgnc2hvdWxkIGdlbmVyYXRlIGNvbXByZWhlbnNpdmUgdXNhZ2UgcmVwb3J0JywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgcXVlcnk6IEFuYWx5dGljc1F1ZXJ5ID0ge1xuICAgICAgICBzdGFydFRpbWU6IG5ldyBEYXRlKCcyMDIzLTAxLTAxVDAwOjAwOjAwWicpLFxuICAgICAgICBlbmRUaW1lOiBuZXcgRGF0ZSgnMjAyMy0wMS0wMlQwMDowMDowMFonKSxcbiAgICAgICAgZ3JhbnVsYXJpdHk6ICdob3VyJ1xuICAgICAgfTtcblxuICAgICAgLy8gTW9jayBDbG91ZFdhdGNoIHJlc3BvbnNlc1xuICAgICAgbW9ja0Nsb3VkV2F0Y2guZ2V0TWV0cmljU3RhdGlzdGljc1xuICAgICAgICAubW9ja1JldHVyblZhbHVlT25jZSh7XG4gICAgICAgICAgcHJvbWlzZTogamVzdC5mbigpLm1vY2tSZXNvbHZlZFZhbHVlKHtcbiAgICAgICAgICAgIERhdGFwb2ludHM6IFtcbiAgICAgICAgICAgICAgeyBTdW06IDEwMCwgVGltZXN0YW1wOiBuZXcgRGF0ZSgnMjAyMy0wMS0wMVQwMTowMDowMFonKSB9LFxuICAgICAgICAgICAgICB7IFN1bTogMTUwLCBUaW1lc3RhbXA6IG5ldyBEYXRlKCcyMDIzLTAxLTAxVDAyOjAwOjAwWicpIH1cbiAgICAgICAgICAgIF1cbiAgICAgICAgICB9KVxuICAgICAgICB9KVxuICAgICAgICAubW9ja1JldHVyblZhbHVlT25jZSh7XG4gICAgICAgICAgcHJvbWlzZTogamVzdC5mbigpLm1vY2tSZXNvbHZlZFZhbHVlKHtcbiAgICAgICAgICAgIERhdGFwb2ludHM6IFtcbiAgICAgICAgICAgICAgeyBTdW06IDUsIFRpbWVzdGFtcDogbmV3IERhdGUoJzIwMjMtMDEtMDFUMDE6MDA6MDBaJykgfVxuICAgICAgICAgICAgXVxuICAgICAgICAgIH0pXG4gICAgICAgIH0pXG4gICAgICAgIC5tb2NrUmV0dXJuVmFsdWVPbmNlKHtcbiAgICAgICAgICBwcm9taXNlOiBqZXN0LmZuKCkubW9ja1Jlc29sdmVkVmFsdWUoe1xuICAgICAgICAgICAgRGF0YXBvaW50czogW1xuICAgICAgICAgICAgICB7IEF2ZXJhZ2U6IDEyMDAsIEV4dGVuZGVkU3RhdGlzdGljczogeyBwOTU6IDIwMDAsIHA5OTogMzAwMCB9IH1cbiAgICAgICAgICAgIF1cbiAgICAgICAgICB9KVxuICAgICAgICB9KVxuICAgICAgICAubW9ja1JldHVyblZhbHVlKHtcbiAgICAgICAgICBwcm9taXNlOiBqZXN0LmZuKCkubW9ja1Jlc29sdmVkVmFsdWUoe1xuICAgICAgICAgICAgRGF0YXBvaW50czogW1xuICAgICAgICAgICAgICB7IFN1bTogMTAsIEF2ZXJhZ2U6IDUwMCB9XG4gICAgICAgICAgICBdXG4gICAgICAgICAgfSlcbiAgICAgICAgfSk7XG5cbiAgICAgIGNvbnN0IHJlcG9ydCA9IGF3YWl0IHVzYWdlQW5hbHl0aWNzU2VydmljZS5nZW5lcmF0ZVVzYWdlUmVwb3J0KHF1ZXJ5KTtcblxuICAgICAgZXhwZWN0KHJlcG9ydCkudG9NYXRjaE9iamVjdCh7XG4gICAgICAgIHBlcmlvZDoge1xuICAgICAgICAgIHN0YXJ0OiBxdWVyeS5zdGFydFRpbWUsXG4gICAgICAgICAgZW5kOiBxdWVyeS5lbmRUaW1lXG4gICAgICAgIH0sXG4gICAgICAgIHRvdGFsUmVxdWVzdHM6IDI1MCxcbiAgICAgICAgZXJyb3JSYXRlOiBleHBlY3QuYW55KE51bWJlciksXG4gICAgICAgIGF2ZXJhZ2VSZXNwb25zZVRpbWU6IGV4cGVjdC5hbnkoTnVtYmVyKVxuICAgICAgfSk7XG5cbiAgICAgIGV4cGVjdChyZXBvcnQubW9kZWxVc2FnZSkudG9CZUluc3RhbmNlT2YoQXJyYXkpO1xuICAgICAgZXhwZWN0KHJlcG9ydC50b3BFbmRwb2ludHMpLnRvQmVJbnN0YW5jZU9mKEFycmF5KTtcbiAgICAgIGV4cGVjdChyZXBvcnQuY29zdEFuYWx5c2lzKS50b0hhdmVQcm9wZXJ0eSgndG90YWxDb3N0Jyk7XG4gICAgICBleHBlY3QocmVwb3J0LnVzZXJFbmdhZ2VtZW50KS50b0hhdmVQcm9wZXJ0eSgnYWN0aXZlVXNlcnMnKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgaGFuZGxlIENsb3VkV2F0Y2ggZXJyb3JzIGdyYWNlZnVsbHknLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBxdWVyeTogQW5hbHl0aWNzUXVlcnkgPSB7XG4gICAgICAgIHN0YXJ0VGltZTogbmV3IERhdGUoJzIwMjMtMDEtMDFUMDA6MDA6MDBaJyksXG4gICAgICAgIGVuZFRpbWU6IG5ldyBEYXRlKCcyMDIzLTAxLTAyVDAwOjAwOjAwWicpXG4gICAgICB9O1xuXG4gICAgICBtb2NrQ2xvdWRXYXRjaC5nZXRNZXRyaWNTdGF0aXN0aWNzLm1vY2tSZXR1cm5WYWx1ZSh7XG4gICAgICAgIHByb21pc2U6IGplc3QuZm4oKS5tb2NrUmVqZWN0ZWRWYWx1ZShuZXcgRXJyb3IoJ0Nsb3VkV2F0Y2ggZXJyb3InKSlcbiAgICAgIH0pO1xuXG4gICAgICBhd2FpdCBleHBlY3QodXNhZ2VBbmFseXRpY3NTZXJ2aWNlLmdlbmVyYXRlVXNhZ2VSZXBvcnQocXVlcnkpKS5yZWplY3RzLnRvVGhyb3coJ0Nsb3VkV2F0Y2ggZXJyb3InKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ2V4cG9ydFVzYWdlRGF0YScsICgpID0+IHtcbiAgICBpdCgnc2hvdWxkIGV4cG9ydCB1c2FnZSBkYXRhIGluIEpTT04gZm9ybWF0JywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgcXVlcnk6IEFuYWx5dGljc1F1ZXJ5ID0ge1xuICAgICAgICBzdGFydFRpbWU6IG5ldyBEYXRlKCcyMDIzLTAxLTAxVDAwOjAwOjAwWicpLFxuICAgICAgICBlbmRUaW1lOiBuZXcgRGF0ZSgnMjAyMy0wMS0wMlQwMDowMDowMFonKVxuICAgICAgfTtcblxuICAgICAgLy8gTW9jayBtaW5pbWFsIENsb3VkV2F0Y2ggcmVzcG9uc2VzXG4gICAgICBtb2NrQ2xvdWRXYXRjaC5nZXRNZXRyaWNTdGF0aXN0aWNzLm1vY2tSZXR1cm5WYWx1ZSh7XG4gICAgICAgIHByb21pc2U6IGplc3QuZm4oKS5tb2NrUmVzb2x2ZWRWYWx1ZSh7XG4gICAgICAgICAgRGF0YXBvaW50czogW3sgU3VtOiAxMDAgfV1cbiAgICAgICAgfSlcbiAgICAgIH0pO1xuXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCB1c2FnZUFuYWx5dGljc1NlcnZpY2UuZXhwb3J0VXNhZ2VEYXRhKHF1ZXJ5LCAnanNvbicpO1xuXG4gICAgICBleHBlY3QocmVzdWx0KS50b0NvbnRhaW4oJ1widG90YWxSZXF1ZXN0c1wiJyk7XG4gICAgICBleHBlY3QocmVzdWx0KS50b0NvbnRhaW4oJ1wicGVyaW9kXCInKTtcbiAgICAgIGV4cGVjdCgoKSA9PiBKU09OLnBhcnNlKHJlc3VsdCkpLm5vdC50b1Rocm93KCk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIGV4cG9ydCB1c2FnZSBkYXRhIGluIENTViBmb3JtYXQnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBxdWVyeTogQW5hbHl0aWNzUXVlcnkgPSB7XG4gICAgICAgIHN0YXJ0VGltZTogbmV3IERhdGUoJzIwMjMtMDEtMDFUMDA6MDA6MDBaJyksXG4gICAgICAgIGVuZFRpbWU6IG5ldyBEYXRlKCcyMDIzLTAxLTAyVDAwOjAwOjAwWicpXG4gICAgICB9O1xuXG4gICAgICAvLyBNb2NrIG1pbmltYWwgQ2xvdWRXYXRjaCByZXNwb25zZXNcbiAgICAgIG1vY2tDbG91ZFdhdGNoLmdldE1ldHJpY1N0YXRpc3RpY3MubW9ja1JldHVyblZhbHVlKHtcbiAgICAgICAgcHJvbWlzZTogamVzdC5mbigpLm1vY2tSZXNvbHZlZFZhbHVlKHtcbiAgICAgICAgICBEYXRhcG9pbnRzOiBbeyBTdW06IDEwMCB9XVxuICAgICAgICB9KVxuICAgICAgfSk7XG5cbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHVzYWdlQW5hbHl0aWNzU2VydmljZS5leHBvcnRVc2FnZURhdGEocXVlcnksICdjc3YnKTtcblxuICAgICAgZXhwZWN0KHJlc3VsdCkudG9Db250YWluKCdNZXRyaWMsVmFsdWUsUGVyaW9kIFN0YXJ0LFBlcmlvZCBFbmQnKTtcbiAgICAgIGV4cGVjdChyZXN1bHQpLnRvQ29udGFpbignVG90YWwgUmVxdWVzdHMnKTtcbiAgICAgIGV4cGVjdChyZXN1bHQpLnRvQ29udGFpbignRXJyb3IgUmF0ZScpO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgncHJpdmF0ZSBoZWxwZXIgbWV0aG9kcycsICgpID0+IHtcbiAgICBpdCgnc2hvdWxkIGNvbnZlcnQgZ3JhbnVsYXJpdHkgdG8gc2Vjb25kcyBjb3JyZWN0bHknLCAoKSA9PiB7XG4gICAgICAvLyBBY2Nlc3MgcHJpdmF0ZSBtZXRob2QgdGhyb3VnaCB0eXBlIGFzc2VydGlvbiBmb3IgdGVzdGluZ1xuICAgICAgY29uc3Qgc2VydmljZSA9IHVzYWdlQW5hbHl0aWNzU2VydmljZSBhcyBhbnk7XG4gICAgICBcbiAgICAgIGV4cGVjdChzZXJ2aWNlLmdldFBlcmlvZEluU2Vjb25kcygnaG91cicpKS50b0JlKDM2MDApO1xuICAgICAgZXhwZWN0KHNlcnZpY2UuZ2V0UGVyaW9kSW5TZWNvbmRzKCdkYXknKSkudG9CZSg4NjQwMCk7XG4gICAgICBleHBlY3Qoc2VydmljZS5nZXRQZXJpb2RJblNlY29uZHMoJ3dlZWsnKSkudG9CZSg2MDQ4MDApO1xuICAgICAgZXhwZWN0KHNlcnZpY2UuZ2V0UGVyaW9kSW5TZWNvbmRzKCdtb250aCcpKS50b0JlKDI1OTIwMDApO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnbWV0cmljIGFnZ3JlZ2F0aW9uJywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgaGFuZGxlIGVtcHR5IGRhdGFwb2ludHMgZ3JhY2VmdWxseScsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IHF1ZXJ5OiBBbmFseXRpY3NRdWVyeSA9IHtcbiAgICAgICAgc3RhcnRUaW1lOiBuZXcgRGF0ZSgnMjAyMy0wMS0wMVQwMDowMDowMFonKSxcbiAgICAgICAgZW5kVGltZTogbmV3IERhdGUoJzIwMjMtMDEtMDJUMDA6MDA6MDBaJylcbiAgICAgIH07XG5cbiAgICAgIG1vY2tDbG91ZFdhdGNoLmdldE1ldHJpY1N0YXRpc3RpY3MubW9ja1JldHVyblZhbHVlKHtcbiAgICAgICAgcHJvbWlzZTogamVzdC5mbigpLm1vY2tSZXNvbHZlZFZhbHVlKHtcbiAgICAgICAgICBEYXRhcG9pbnRzOiBbXVxuICAgICAgICB9KVxuICAgICAgfSk7XG5cbiAgICAgIGNvbnN0IHJlcG9ydCA9IGF3YWl0IHVzYWdlQW5hbHl0aWNzU2VydmljZS5nZW5lcmF0ZVVzYWdlUmVwb3J0KHF1ZXJ5KTtcblxuICAgICAgZXhwZWN0KHJlcG9ydC50b3RhbFJlcXVlc3RzKS50b0JlKDApO1xuICAgICAgZXhwZWN0KHJlcG9ydC5lcnJvclJhdGUpLnRvQmUoMCk7XG4gICAgICBleHBlY3QocmVwb3J0LmF2ZXJhZ2VSZXNwb25zZVRpbWUpLnRvQmUoMCk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIGZpbHRlciBvdXQgbW9kZWxzIHdpdGggemVybyB1c2FnZScsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IHF1ZXJ5OiBBbmFseXRpY3NRdWVyeSA9IHtcbiAgICAgICAgc3RhcnRUaW1lOiBuZXcgRGF0ZSgnMjAyMy0wMS0wMVQwMDowMDowMFonKSxcbiAgICAgICAgZW5kVGltZTogbmV3IERhdGUoJzIwMjMtMDEtMDJUMDA6MDA6MDBaJylcbiAgICAgIH07XG5cbiAgICAgIC8vIE1vY2sgcmVzcG9uc2VzIHdoZXJlIHNvbWUgbW9kZWxzIGhhdmUgemVybyB1c2FnZVxuICAgICAgbGV0IGNhbGxDb3VudCA9IDA7XG4gICAgICBtb2NrQ2xvdWRXYXRjaC5nZXRNZXRyaWNTdGF0aXN0aWNzLm1vY2tJbXBsZW1lbnRhdGlvbigoKSA9PiB7XG4gICAgICAgIGNhbGxDb3VudCsrO1xuICAgICAgICBjb25zdCByZXNwb25zZXMgPSBbXG4gICAgICAgICAgeyBEYXRhcG9pbnRzOiBbeyBTdW06IDEwMCB9XSB9LCAvLyBUb3RhbCByZXF1ZXN0c1xuICAgICAgICAgIHsgRGF0YXBvaW50czogW3sgU3VtOiA1IH1dIH0sICAgLy8gRXJyb3JzXG4gICAgICAgICAgeyBEYXRhcG9pbnRzOiBbeyBBdmVyYWdlOiAxMjAwIH1dIH0sIC8vIFJlc3BvbnNlIHRpbWVcbiAgICAgICAgICB7IERhdGFwb2ludHM6IFt7IFN1bTogNTAgfV0gfSwgIC8vIE1vZGVsIDEgdXNhZ2VcbiAgICAgICAgICB7IERhdGFwb2ludHM6IFt7IFN1bTogMCB9XSB9LCAgIC8vIE1vZGVsIDEgdG9rZW5zXG4gICAgICAgICAgeyBEYXRhcG9pbnRzOiBbeyBTdW06IDAgfV0gfSwgICAvLyBNb2RlbCAxIGNvc3RcbiAgICAgICAgICB7IERhdGFwb2ludHM6IFt7IEF2ZXJhZ2U6IDEwMDAgfV0gfSwgLy8gTW9kZWwgMSByZXNwb25zZSB0aW1lXG4gICAgICAgICAgeyBEYXRhcG9pbnRzOiBbeyBTdW06IDQ1IH1dIH0sICAvLyBNb2RlbCAxIHN1Y2Nlc3MgY2FsbHNcbiAgICAgICAgICB7IERhdGFwb2ludHM6IFt7IFN1bTogMCB9XSB9LCAgIC8vIE1vZGVsIDIgdXNhZ2UgKHplcm8pXG4gICAgICAgICAgeyBEYXRhcG9pbnRzOiBbXSB9XG4gICAgICAgIF07XG4gICAgICAgIFxuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIHByb21pc2U6IGplc3QuZm4oKS5tb2NrUmVzb2x2ZWRWYWx1ZShyZXNwb25zZXNbY2FsbENvdW50IC0gMV0gfHwgeyBEYXRhcG9pbnRzOiBbXSB9KVxuICAgICAgICB9O1xuICAgICAgfSk7XG5cbiAgICAgIGNvbnN0IHJlcG9ydCA9IGF3YWl0IHVzYWdlQW5hbHl0aWNzU2VydmljZS5nZW5lcmF0ZVVzYWdlUmVwb3J0KHF1ZXJ5KTtcblxuICAgICAgLy8gU2hvdWxkIG9ubHkgaW5jbHVkZSBtb2RlbHMgd2l0aCB1c2FnZSA+IDBcbiAgICAgIGV4cGVjdChyZXBvcnQubW9kZWxVc2FnZSkudG9IYXZlTGVuZ3RoKDEpO1xuICAgICAgZXhwZWN0KHJlcG9ydC5tb2RlbFVzYWdlWzBdLnRvdGFsQ2FsbHMpLnRvQmUoNTApO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnY29zdCBhbmFseXNpcycsICgpID0+IHtcbiAgICBpdCgnc2hvdWxkIGNhbGN1bGF0ZSBwcm9qZWN0ZWQgbW9udGhseSBjb3N0IGNvcnJlY3RseScsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IHF1ZXJ5OiBBbmFseXRpY3NRdWVyeSA9IHtcbiAgICAgICAgc3RhcnRUaW1lOiBuZXcgRGF0ZSgnMjAyMy0wMS0wMVQwMDowMDowMFonKSxcbiAgICAgICAgZW5kVGltZTogbmV3IERhdGUoJzIwMjMtMDEtMDJUMDA6MDA6MDBaJykgLy8gMSBkYXkgcGVyaW9kXG4gICAgICB9O1xuXG4gICAgICAvLyBNb2NrIGNvc3Qgb2YgJDEwIGZvciAxIGRheVxuICAgICAgbGV0IGNhbGxDb3VudCA9IDA7XG4gICAgICBtb2NrQ2xvdWRXYXRjaC5nZXRNZXRyaWNTdGF0aXN0aWNzLm1vY2tJbXBsZW1lbnRhdGlvbigoKSA9PiB7XG4gICAgICAgIGNhbGxDb3VudCsrO1xuICAgICAgICBjb25zdCByZXNwb25zZXMgPSBbXG4gICAgICAgICAgeyBEYXRhcG9pbnRzOiBbeyBTdW06IDEwMCB9XSB9LCAvLyBUb3RhbCByZXF1ZXN0c1xuICAgICAgICAgIHsgRGF0YXBvaW50czogW3sgU3VtOiA1IH1dIH0sICAgLy8gRXJyb3JzXG4gICAgICAgICAgeyBEYXRhcG9pbnRzOiBbeyBBdmVyYWdlOiAxMjAwIH1dIH0sIC8vIFJlc3BvbnNlIHRpbWVcbiAgICAgICAgICB7IERhdGFwb2ludHM6IFt7IFN1bTogMTAgfV0gfSAgICAgLy8gVG90YWwgY29zdFxuICAgICAgICBdO1xuICAgICAgICBcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICBwcm9taXNlOiBqZXN0LmZuKCkubW9ja1Jlc29sdmVkVmFsdWUocmVzcG9uc2VzW2NhbGxDb3VudCAtIDFdIHx8IHsgRGF0YXBvaW50czogW3sgU3VtOiAxMCB9XSB9KVxuICAgICAgICB9O1xuICAgICAgfSk7XG5cbiAgICAgIGNvbnN0IHJlcG9ydCA9IGF3YWl0IHVzYWdlQW5hbHl0aWNzU2VydmljZS5nZW5lcmF0ZVVzYWdlUmVwb3J0KHF1ZXJ5KTtcblxuICAgICAgLy8gU2hvdWxkIHByb2plY3QgJDMwMCBmb3IgMzAgZGF5cyAoJDEwICogMzApXG4gICAgICBleHBlY3QocmVwb3J0LmNvc3RBbmFseXNpcy5wcm9qZWN0ZWRNb250aGx5Q29zdCkudG9CZSgzMDApO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnZW5kcG9pbnQgZmlsdGVyaW5nJywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgc29ydCBlbmRwb2ludHMgYnkgcmVxdWVzdCBjb3VudCcsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IHF1ZXJ5OiBBbmFseXRpY3NRdWVyeSA9IHtcbiAgICAgICAgc3RhcnRUaW1lOiBuZXcgRGF0ZSgnMjAyMy0wMS0wMVQwMDowMDowMFonKSxcbiAgICAgICAgZW5kVGltZTogbmV3IERhdGUoJzIwMjMtMDEtMDJUMDA6MDA6MDBaJylcbiAgICAgIH07XG5cbiAgICAgIC8vIE1vY2sgZGlmZmVyZW50IHJlcXVlc3QgY291bnRzIGZvciBkaWZmZXJlbnQgZW5kcG9pbnRzXG4gICAgICBsZXQgY2FsbENvdW50ID0gMDtcbiAgICAgIG1vY2tDbG91ZFdhdGNoLmdldE1ldHJpY1N0YXRpc3RpY3MubW9ja0ltcGxlbWVudGF0aW9uKCgpID0+IHtcbiAgICAgICAgY2FsbENvdW50Kys7XG4gICAgICAgIGlmIChjYWxsQ291bnQgPD0gMykge1xuICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBwcm9taXNlOiBqZXN0LmZuKCkubW9ja1Jlc29sdmVkVmFsdWUoeyBEYXRhcG9pbnRzOiBbeyBTdW06IDEwMCB9XSB9KVxuICAgICAgICAgIH07XG4gICAgICAgIH1cbiAgICAgICAgLy8gRm9yIGVuZHBvaW50IHN0YXRzLCByZXR1cm4gZGlmZmVyZW50IHZhbHVlc1xuICAgICAgICBjb25zdCBlbmRwb2ludENvdW50cyA9IFs1MCwgMTAwLCAyNSwgNzUsIDEwXTsgLy8gRGlmZmVyZW50IHJlcXVlc3QgY291bnRzXG4gICAgICAgIGNvbnN0IGluZGV4ID0gKGNhbGxDb3VudCAtIDQpICUgMTU7IC8vIDMgbWV0cmljcyBwZXIgZW5kcG9pbnQgKiA1IGVuZHBvaW50c1xuICAgICAgICBjb25zdCBtZXRyaWNJbmRleCA9IE1hdGguZmxvb3IoaW5kZXggLyA1KTtcbiAgICAgICAgY29uc3QgZW5kcG9pbnRJbmRleCA9IGluZGV4ICUgNTtcbiAgICAgICAgXG4gICAgICAgIGlmIChtZXRyaWNJbmRleCA9PT0gMCkgeyAvLyBSZXF1ZXN0IGNvdW50XG4gICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIHByb21pc2U6IGplc3QuZm4oKS5tb2NrUmVzb2x2ZWRWYWx1ZSh7IERhdGFwb2ludHM6IFt7IFN1bTogZW5kcG9pbnRDb3VudHNbZW5kcG9pbnRJbmRleF0gfV0gfSlcbiAgICAgICAgICB9O1xuICAgICAgICB9IGVsc2UgeyAvLyBSZXNwb25zZSB0aW1lIG9yIGVycm9yIGNvdW50XG4gICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIHByb21pc2U6IGplc3QuZm4oKS5tb2NrUmVzb2x2ZWRWYWx1ZSh7IERhdGFwb2ludHM6IFt7IEF2ZXJhZ2U6IDEwMDAsIFN1bTogMSB9XSB9KVxuICAgICAgICAgIH07XG4gICAgICAgIH1cbiAgICAgIH0pO1xuXG4gICAgICBjb25zdCByZXBvcnQgPSBhd2FpdCB1c2FnZUFuYWx5dGljc1NlcnZpY2UuZ2VuZXJhdGVVc2FnZVJlcG9ydChxdWVyeSk7XG5cbiAgICAgIC8vIFNob3VsZCBiZSBzb3J0ZWQgYnkgcmVxdWVzdCBjb3VudCAoZGVzY2VuZGluZylcbiAgICAgIGV4cGVjdChyZXBvcnQudG9wRW5kcG9pbnRzLmxlbmd0aCkudG9CZUdyZWF0ZXJUaGFuKDApO1xuICAgICAgZm9yIChsZXQgaSA9IDE7IGkgPCByZXBvcnQudG9wRW5kcG9pbnRzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgIGV4cGVjdChyZXBvcnQudG9wRW5kcG9pbnRzW2ktMV0ucmVxdWVzdENvdW50KS50b0JlR3JlYXRlclRoYW5PckVxdWFsKFxuICAgICAgICAgIHJlcG9ydC50b3BFbmRwb2ludHNbaV0ucmVxdWVzdENvdW50XG4gICAgICAgICk7XG4gICAgICB9XG4gICAgfSk7XG4gIH0pO1xufSk7Il19