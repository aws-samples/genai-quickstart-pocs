"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const logger_1 = require("../logging/logger");
// Mock AWS SDK
jest.mock('aws-sdk', () => ({
    CloudWatchLogs: jest.fn().mockImplementation(() => ({
        createLogGroup: jest.fn().mockReturnValue({
            promise: jest.fn().mockResolvedValue({})
        }),
        createLogStream: jest.fn().mockReturnValue({
            promise: jest.fn().mockResolvedValue({})
        }),
        putLogEvents: jest.fn().mockReturnValue({
            promise: jest.fn().mockResolvedValue({ nextSequenceToken: 'token123' })
        })
    }))
}));
describe('Logger', () => {
    let logger;
    let mockCloudWatchLogs;
    beforeEach(() => {
        jest.clearAllMocks();
        logger = new logger_1.Logger('/test/log-group', 'test', '1.0.0');
        const { CloudWatchLogs } = require('aws-sdk');
        mockCloudWatchLogs = CloudWatchLogs.mock.results[0].value;
    });
    describe('log levels', () => {
        it('should have correct log levels defined', () => {
            expect(logger_1.LOG_LEVELS.DEBUG).toBe('debug');
            expect(logger_1.LOG_LEVELS.INFO).toBe('info');
            expect(logger_1.LOG_LEVELS.WARN).toBe('warn');
            expect(logger_1.LOG_LEVELS.ERROR).toBe('error');
            expect(logger_1.LOG_LEVELS.CRITICAL).toBe('critical');
        });
    });
    describe('logging methods', () => {
        it('should log debug messages', async () => {
            await logger.debug('TestService', 'testOperation', 'Debug message', { key: 'value' });
            expect(mockCloudWatchLogs.putLogEvents).toHaveBeenCalledWith(expect.objectContaining({
                logEvents: expect.arrayContaining([
                    expect.objectContaining({
                        message: expect.stringContaining('"level":"DEBUG"')
                    })
                ])
            }));
        });
        it('should log info messages', async () => {
            await logger.info('TestService', 'testOperation', 'Info message', { key: 'value' });
            expect(mockCloudWatchLogs.putLogEvents).toHaveBeenCalledWith(expect.objectContaining({
                logEvents: expect.arrayContaining([
                    expect.objectContaining({
                        message: expect.stringContaining('"level":"INFO"')
                    })
                ])
            }));
        });
        it('should log error messages with error objects', async () => {
            const testError = new Error('Test error');
            await logger.error('TestService', 'testOperation', 'Error message', testError, { key: 'value' });
            expect(mockCloudWatchLogs.putLogEvents).toHaveBeenCalledWith(expect.objectContaining({
                logEvents: expect.arrayContaining([
                    expect.objectContaining({
                        message: expect.stringContaining('"level":"ERROR"')
                    })
                ])
            }));
        });
    });
    describe('structured logging', () => {
        it('should include all required fields in log entries', async () => {
            const context = {
                userId: 'user123',
                requestId: 'req123',
                sessionId: 'session123'
            };
            await logger.info('TestService', 'testOperation', 'Test message', { key: 'value' }, context);
            expect(mockCloudWatchLogs.putLogEvents).toHaveBeenCalled();
            const logEvent = mockCloudWatchLogs.putLogEvents.mock.calls[0][0].logEvents[0];
            const logEntry = JSON.parse(logEvent.message);
            expect(logEntry).toMatchObject({
                level: 'INFO',
                service: 'TestService',
                operation: 'testOperation',
                message: 'Test message',
                metadata: { key: 'value' },
                userId: 'user123',
                requestId: 'req123',
                sessionId: 'session123',
                environment: 'test',
                version: '1.0.0',
                source: 'investment-ai-agent'
            });
            expect(logEntry.timestamp).toBeDefined();
            expect(logEntry.tags).toContain('level:INFO');
            expect(logEntry.tags).toContain('service:TestService');
            expect(logEntry.tags).toContain('user:user123');
        });
    });
    describe('error handling', () => {
        it('should handle CloudWatch errors gracefully', async () => {
            mockCloudWatchLogs.putLogEvents.mockReturnValueOnce({
                promise: jest.fn().mockRejectedValue(new Error('CloudWatch error'))
            });
            const consoleSpy = jest.spyOn(console, 'error').mockImplementation();
            await logger.info('TestService', 'testOperation', 'Test message');
            expect(consoleSpy).toHaveBeenCalledWith('Failed to send logs to CloudWatch:', expect.any(Error));
            consoleSpy.mockRestore();
        });
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibG9nZ2VyLnRlc3QuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvc2VydmljZXMvX190ZXN0c19fL2xvZ2dlci50ZXN0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsOENBQXVEO0FBRXZELGVBQWU7QUFDZixJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsRUFBRSxHQUFHLEVBQUUsQ0FBQyxDQUFDO0lBQzFCLGNBQWMsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUMsa0JBQWtCLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQztRQUNsRCxjQUFjLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDLGVBQWUsQ0FBQztZQUN4QyxPQUFPLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDLGlCQUFpQixDQUFDLEVBQUUsQ0FBQztTQUN6QyxDQUFDO1FBQ0YsZUFBZSxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQyxlQUFlLENBQUM7WUFDekMsT0FBTyxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQyxpQkFBaUIsQ0FBQyxFQUFFLENBQUM7U0FDekMsQ0FBQztRQUNGLFlBQVksRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUMsZUFBZSxDQUFDO1lBQ3RDLE9BQU8sRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUMsaUJBQWlCLENBQUMsRUFBRSxpQkFBaUIsRUFBRSxVQUFVLEVBQUUsQ0FBQztTQUN4RSxDQUFDO0tBQ0gsQ0FBQyxDQUFDO0NBQ0osQ0FBQyxDQUFDLENBQUM7QUFFSixRQUFRLENBQUMsUUFBUSxFQUFFLEdBQUcsRUFBRTtJQUN0QixJQUFJLE1BQWMsQ0FBQztJQUNuQixJQUFJLGtCQUF1QixDQUFDO0lBRTVCLFVBQVUsQ0FBQyxHQUFHLEVBQUU7UUFDZCxJQUFJLENBQUMsYUFBYSxFQUFFLENBQUM7UUFDckIsTUFBTSxHQUFHLElBQUksZUFBTSxDQUFDLGlCQUFpQixFQUFFLE1B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QUMsQ0FBQztBQUNMLENBQUMsQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgTG9nZ2VyLCBMT0dfTEVWRUxTIH0gZnJvbSAnLi4vbG9nZ2luZy9sb2dnZXInO1xuXG4vLyBNb2NrIEFXUyBTREtcbmplc3QubW9jaygnYXdzLXNkaycsICgpID0+ICh7XG4gIENsb3VkV2F0Y2hMb2dzOiBqZXN0LmZuKCkubW9ja0ltcGxlbWVudGF0aW9uKCgpID0+ICh7XG4gICAgY3JlYXRlTG9nR3JvdXA6IGplc3QuZm4oKS5tb2NrUmV0dXJuVmFsdWUoe1xuICAgICAgcHJvbWlzZTogamVzdC5mbigpLm1vY2tSZXNvbHZlZFZhbHVlKHt9KVxuICAgIH0pLFxuICAgIGNyZWF0ZUxvZ1N0cmVhbTogamVzdC5mbigpLm1vY2tSZXR1cm5WYWx1ZSh7XG4gICAgICBwcm9taXNlOiBqZXN0LmZuKCkubW9ja1Jlc29sdmVkVmFsdWUoe30pXG4gICAgfSksXG4gICAgcHV0TG9nRXZlbnRzOiBqZXN0LmZuKCkubW9ja1JldHVyblZhbHVlKHtcbiAgICAgIHByb21pc2U6IGplc3QuZm4oKS5tb2NrUmVzb2x2ZWRWYWx1ZSh7IG5leHRTZXF1ZW5jZVRva2VuOiAndG9rZW4xMjMnIH0pXG4gICAgfSlcbiAgfSkpXG59KSk7XG5cbmRlc2NyaWJlKCdMb2dnZXInLCAoKSA9PiB7XG4gIGxldCBsb2dnZXI6IExvZ2dlcjtcbiAgbGV0IG1vY2tDbG91ZFdhdGNoTG9nczogYW55O1xuXG4gIGJlZm9yZUVhY2goKCkgPT4ge1xuICAgIGplc3QuY2xlYXJBbGxNb2NrcygpO1xuICAgIGxvZ2dlciA9IG5ldyBMb2dnZXIoJy90ZXN0L2xvZy1ncm91cCcsICd0ZXN0JywgJzEuMC4wJyk7XG4gICAgY29uc3QgeyBDbG91ZFdhdGNoTG9ncyB9ID0gcmVxdWlyZSgnYXdzLXNkaycpO1xuICAgIG1vY2tDbG91ZFdhdGNoTG9ncyA9IENsb3VkV2F0Y2hMb2dzLm1vY2sucmVzdWx0c1swXS52YWx1ZTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ2xvZyBsZXZlbHMnLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCBoYXZlIGNvcnJlY3QgbG9nIGxldmVscyBkZWZpbmVkJywgKCkgPT4ge1xuICAgICAgZXhwZWN0KExPR19MRVZFTFMuREVCVUcpLnRvQmUoJ2RlYnVnJyk7XG4gICAgICBleHBlY3QoTE9HX0xFVkVMUy5JTkZPKS50b0JlKCdpbmZvJyk7XG4gICAgICBleHBlY3QoTE9HX0xFVkVMUy5XQVJOKS50b0JlKCd3YXJuJyk7XG4gICAgICBleHBlY3QoTE9HX0xFVkVMUy5FUlJPUikudG9CZSgnZXJyb3InKTtcbiAgICAgIGV4cGVjdChMT0dfTEVWRUxTLkNSSVRJQ0FMKS50b0JlKCdjcml0aWNhbCcpO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnbG9nZ2luZyBtZXRob2RzJywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgbG9nIGRlYnVnIG1lc3NhZ2VzJywgYXN5bmMgKCkgPT4ge1xuICAgICAgYXdhaXQgbG9nZ2VyLmRlYnVnKCdUZXN0U2VydmljZScsICd0ZXN0T3BlcmF0aW9uJywgJ0RlYnVnIG1lc3NhZ2UnLCB7IGtleTogJ3ZhbHVlJyB9KTtcblxuICAgICAgZXhwZWN0KG1vY2tDbG91ZFdhdGNoTG9ncy5wdXRMb2dFdmVudHMpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFxuICAgICAgICBleHBlY3Qub2JqZWN0Q29udGFpbmluZyh7XG4gICAgICAgICAgbG9nRXZlbnRzOiBleHBlY3QuYXJyYXlDb250YWluaW5nKFtcbiAgICAgICAgICAgIGV4cGVjdC5vYmplY3RDb250YWluaW5nKHtcbiAgICAgICAgICAgICAgbWVzc2FnZTogZXhwZWN0LnN0cmluZ0NvbnRhaW5pbmcoJ1wibGV2ZWxcIjpcIkRFQlVHXCInKVxuICAgICAgICAgICAgfSlcbiAgICAgICAgICBdKVxuICAgICAgICB9KVxuICAgICAgKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgbG9nIGluZm8gbWVzc2FnZXMnLCBhc3luYyAoKSA9PiB7XG4gICAgICBhd2FpdCBsb2dnZXIuaW5mbygnVGVzdFNlcnZpY2UnLCAndGVzdE9wZXJhdGlvbicsICdJbmZvIG1lc3NhZ2UnLCB7IGtleTogJ3ZhbHVlJyB9KTtcblxuICAgICAgZXhwZWN0KG1vY2tDbG91ZFdhdGNoTG9ncy5wdXRMb2dFdmVudHMpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFxuICAgICAgICBleHBlY3Qub2JqZWN0Q29udGFpbmluZyh7XG4gICAgICAgICAgbG9nRXZlbnRzOiBleHBlY3QuYXJyYXlDb250YWluaW5nKFtcbiAgICAgICAgICAgIGV4cGVjdC5vYmplY3RDb250YWluaW5nKHtcbiAgICAgICAgICAgICAgbWVzc2FnZTogZXhwZWN0LnN0cmluZ0NvbnRhaW5pbmcoJ1wibGV2ZWxcIjpcIklORk9cIicpXG4gICAgICAgICAgICB9KVxuICAgICAgICAgIF0pXG4gICAgICAgIH0pXG4gICAgICApO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBsb2cgZXJyb3IgbWVzc2FnZXMgd2l0aCBlcnJvciBvYmplY3RzJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgdGVzdEVycm9yID0gbmV3IEVycm9yKCdUZXN0IGVycm9yJyk7XG4gICAgICBhd2FpdCBsb2dnZXIuZXJyb3IoJ1Rlc3RTZXJ2aWNlJywgJ3Rlc3RPcGVyYXRpb24nLCAnRXJyb3IgbWVzc2FnZScsIHRlc3RFcnJvciwgeyBrZXk6ICd2YWx1ZScgfSk7XG5cbiAgICAgIGV4cGVjdChtb2NrQ2xvdWRXYXRjaExvZ3MucHV0TG9nRXZlbnRzKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcbiAgICAgICAgZXhwZWN0Lm9iamVjdENvbnRhaW5pbmcoe1xuICAgICAgICAgIGxvZ0V2ZW50czogZXhwZWN0LmFycmF5Q29udGFpbmluZyhbXG4gICAgICAgICAgICBleHBlY3Qub2JqZWN0Q29udGFpbmluZyh7XG4gICAgICAgICAgICAgIG1lc3NhZ2U6IGV4cGVjdC5zdHJpbmdDb250YWluaW5nKCdcImxldmVsXCI6XCJFUlJPUlwiJylcbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgXSlcbiAgICAgICAgfSlcbiAgICAgICk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdzdHJ1Y3R1cmVkIGxvZ2dpbmcnLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCBpbmNsdWRlIGFsbCByZXF1aXJlZCBmaWVsZHMgaW4gbG9nIGVudHJpZXMnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBjb250ZXh0ID0ge1xuICAgICAgICB1c2VySWQ6ICd1c2VyMTIzJyxcbiAgICAgICAgcmVxdWVzdElkOiAncmVxMTIzJyxcbiAgICAgICAgc2Vzc2lvbklkOiAnc2Vzc2lvbjEyMydcbiAgICAgIH07XG5cbiAgICAgIGF3YWl0IGxvZ2dlci5pbmZvKCdUZXN0U2VydmljZScsICd0ZXN0T3BlcmF0aW9uJywgJ1Rlc3QgbWVzc2FnZScsIHsga2V5OiAndmFsdWUnIH0sIGNvbnRleHQpO1xuXG4gICAgICBleHBlY3QobW9ja0Nsb3VkV2F0Y2hMb2dzLnB1dExvZ0V2ZW50cykudG9IYXZlQmVlbkNhbGxlZCgpO1xuICAgICAgY29uc3QgbG9nRXZlbnQgPSBtb2NrQ2xvdWRXYXRjaExvZ3MucHV0TG9nRXZlbnRzLm1vY2suY2FsbHNbMF1bMF0ubG9nRXZlbnRzWzBdO1xuICAgICAgY29uc3QgbG9nRW50cnkgPSBKU09OLnBhcnNlKGxvZ0V2ZW50Lm1lc3NhZ2UpO1xuXG4gICAgICBleHBlY3QobG9nRW50cnkpLnRvTWF0Y2hPYmplY3Qoe1xuICAgICAgICBsZXZlbDogJ0lORk8nLFxuICAgICAgICBzZXJ2aWNlOiAnVGVzdFNlcnZpY2UnLFxuICAgICAgICBvcGVyYXRpb246ICd0ZXN0T3BlcmF0aW9uJyxcbiAgICAgICAgbWVzc2FnZTogJ1Rlc3QgbWVzc2FnZScsXG4gICAgICAgIG1ldGFkYXRhOiB7IGtleTogJ3ZhbHVlJyB9LFxuICAgICAgICB1c2VySWQ6ICd1c2VyMTIzJyxcbiAgICAgICAgcmVxdWVzdElkOiAncmVxMTIzJyxcbiAgICAgICAgc2Vzc2lvbklkOiAnc2Vzc2lvbjEyMycsXG4gICAgICAgIGVudmlyb25tZW50OiAndGVzdCcsXG4gICAgICAgIHZlcnNpb246ICcxLjAuMCcsXG4gICAgICAgIHNvdXJjZTogJ2ludmVzdG1lbnQtYWktYWdlbnQnXG4gICAgICB9KTtcblxuICAgICAgZXhwZWN0KGxvZ0VudHJ5LnRpbWVzdGFtcCkudG9CZURlZmluZWQoKTtcbiAgICAgIGV4cGVjdChsb2dFbnRyeS50YWdzKS50b0NvbnRhaW4oJ2xldmVsOklORk8nKTtcbiAgICAgIGV4cGVjdChsb2dFbnRyeS50YWdzKS50b0NvbnRhaW4oJ3NlcnZpY2U6VGVzdFNlcnZpY2UnKTtcbiAgICAgIGV4cGVjdChsb2dFbnRyeS50YWdzKS50b0NvbnRhaW4oJ3VzZXI6dXNlcjEyMycpO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnZXJyb3IgaGFuZGxpbmcnLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCBoYW5kbGUgQ2xvdWRXYXRjaCBlcnJvcnMgZ3JhY2VmdWxseScsIGFzeW5jICgpID0+IHtcbiAgICAgIG1vY2tDbG91ZFdhdGNoTG9ncy5wdXRMb2dFdmVudHMubW9ja1JldHVyblZhbHVlT25jZSh7XG4gICAgICAgIHByb21pc2U6IGplc3QuZm4oKS5tb2NrUmVqZWN0ZWRWYWx1ZShuZXcgRXJyb3IoJ0Nsb3VkV2F0Y2ggZXJyb3InKSlcbiAgICAgIH0pO1xuXG4gICAgICBjb25zdCBjb25zb2xlU3B5ID0gamVzdC5zcHlPbihjb25zb2xlLCAnZXJyb3InKS5tb2NrSW1wbGVtZW50YXRpb24oKTtcblxuICAgICAgYXdhaXQgbG9nZ2VyLmluZm8oJ1Rlc3RTZXJ2aWNlJywgJ3Rlc3RPcGVyYXRpb24nLCAnVGVzdCBtZXNzYWdlJyk7XG5cbiAgICAgIGV4cGVjdChjb25zb2xlU3B5KS50b0hhdmVCZWVuQ2FsbGVkV2l0aCgnRmFpbGVkIHRvIHNlbmQgbG9ncyB0byBDbG91ZFdhdGNoOicsIGV4cGVjdC5hbnkoRXJyb3IpKTtcblxuICAgICAgY29uc29sZVNweS5tb2NrUmVzdG9yZSgpO1xuICAgIH0pO1xuICB9KTtcbn0pOyJdfQ==