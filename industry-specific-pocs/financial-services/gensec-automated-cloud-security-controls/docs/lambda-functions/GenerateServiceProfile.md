# GenerateServiceProfile Lambda Function

## Overview

Generates Security Research Profiles for AWS services to help security architects evaluate services for enterprise deployment. This function runs AFTER GenerateIAMModel in the Step Function workflow to leverage IAM models and business use cases.

## Purpose

Creates comprehensive security evaluation documents similar to enterprise security questionnaires, covering:
- Data protection (encryption, data handling)
- Network controls (VPC, endpoints, isolation)
- Access controls (IAM, fine-grained permissions)
- Compliance and governance
- Service quotas and operational considerations

## Workflow Position

```
ValidateAndCollectServiceData → AnalyzeRequirements → GenerateSecurityControls → 
GenerateIaCTemplate → GenerateIAMModel → GenerateServiceProfile ✓
```

**Key Change**: Moved AFTER GenerateIAMModel (previously before) to leverage IAM model outputs.

## Input

```json
{
  "serviceId": "ssm",
  "requestId": "req-123"
}
```

## Data Sources

### 1. IAM Model Outputs (from S3)
- **Path**: `{service_id}/iam-models/iam_model.json`
- **Contains**: All IAM actions with descriptions, access levels, restrictions
- **Generated by**: GenerateIAMModel Lambda

### 2. Business Use Cases (from S3)
- **Path**: `{service_id}/iam-models/business_use_cases.json`
- **Contains**: Personas, activities, IAM permissions, constraints
- **Generated by**: GenerateIAMModel Lambda

### 3. Service Documentation (from DynamoDB)
- **Tables**: 
  - `gensec-AWSServiceActions`
  - `gensec-AWSServiceParameters`
- **Contains**: Raw service actions and CloudFormation parameters

## Output

Generates **TWO** outputs per service:

### 1. Original Service Profile (JSON + Markdown)
- **JSON Path**: `{service_id}/service-profiles/profile.json`
- **Markdown Path**: `{service_id}/service-profiles/profile.md`
- **Format**: Structured JSON with service capabilities, data protection, network controls, etc.

### 2. Security Research Profile (Markdown)
- **Path**: `{service_id}/service-profiles/security_research_profile.md`
- **Format**: Comprehensive Q&A document for security evaluation
- **Scope**: Covers ENTIRE service - architecture, operations, compliance, security controls (not just IAM)
- **Location**: Same folder as `profile.json` and `profile.md`

### Document Structure

```markdown
# Security Research Profile for {Service Name}

## Service Description
Technical overview for architects/SREs

## Major Findings Summary
- Key security/operational characteristics
- Compliance certifications
- Service maturity
- Notable limitations

## Provider Questions - Rapid Pilot Enablement

### Data Protection
Q1: Does the service process or store customer data?
Q2: Encryption at rest?
Q3: Encryption in transit?

### Network Controls
Q4: VPC Integration?
Q5: Service endpoints?

### Access Controls
Q6: IAM integration?
Q7: Fine-grained access control?

## Provider Questions - Full Production Enablement

### Data Protection
Q8: Data residency controls?
Q9: Data lifecycle management?

### Access Controls
Q10: Access logging and audit?

### Isolation Controls
Q11: Multi-tenancy model?
Q12: Resource isolation?

### Management & Operations
Q13: Monitoring and observability?
Q14: Compliance and governance?
Q15: Service quotas and limits?
```

## Response

```json
{
  "statusCode": 200,
  "body": {
    "serviceId": "ssm",
    "serviceName": "AWS Systems Manager",
    "outputs": {
      "service_profile_json": "ssm/service-profiles/profile.json",
      "service_profile_md": "ssm/service-profiles/profile.md",
      "security_research_profile": "ssm/service-profiles/security_research_profile.md"
    },
    "metadata": {
      "actions_count": 150,
      "parameters_count": 45,
      "personas_count": 6,
      "generation_timestamp": "2024-11-20T10:30:00Z"
    }
  }
}
```

## Key Functions

### `load_iam_model_outputs(service_id)`
Loads IAM model and business use cases from S3.

**Returns**: `(iam_model, business_use_cases)`

**Raises**: `ValueError` if IAM model outputs not found (indicates GenerateIAMModel hasn't run)

### `create_security_research_profile_prompt(...)`
Creates comprehensive Bedrock prompt with all available data sources.

**Parameters**:
- `service_name`: Full AWS service name
- `iam_model`: IAM model JSON from S3
- `business_use_cases`: Business use cases JSON from S3
- `validated_actions`: Actions from DynamoDB
- `validated_parameters`: Parameters from DynamoDB

**Returns**: Prompt dictionary for Bedrock

### `create_service_profile_prompt(service_name, validated_parameters, validated_actions)`
Creates prompt for original service profile (JSON format).

**Returns**: Prompt dictionary for Bedrock

### `store_service_profile_outputs(service_id, profile_json, markdown_content)`
Stores the original service profile in both JSON and Markdown formats.

**S3 Paths**: 
- `{service_id}/service-profiles/profile.json`
- `{service_id}/service-profiles/profile.md`

### `store_security_research_profile(service_id, markdown_content)`
Stores the Security Research Profile in S3.

**S3 Path**: `{service_id}/service-profiles/security_research_profile.md`

## Environment Variables

| Variable | Description | Example |
|----------|-------------|---------|
| `DYNAMODB_TABLE_SERVICE_ACTIONS` | Service actions table | `gensec-AWSServiceActions` |
| `DYNAMODB_TABLE_SERVICE_PARAMETERS` | Service parameters table | `gensec-AWSServiceParameters` |
| `S3_OUTPUT_BUCKET` | Output bucket for profiles | `gensec-security-config-outputs-...` |
| `USE_STRANDS_AGENT` | Use Strands Agent (optional) | `false` |
| `STRANDS_AGENT_ID` | Strands Agent ID (if enabled) | `YWZMJLEXED` |

## Dependencies

### Lambda Layers
- **common-layer**: `service_name_resolver`
- **dynamodb-operations-layer**: `get_service_actions_from_dynamodb`, `get_service_parameters_from_dynamodb`
- **validation-layer**: `validate_input`
- **bedrock-layer**: `get_bedrock_client`

### AWS Services
- **S3**: Read IAM model outputs, write Security Research Profile
- **DynamoDB**: Read service actions and parameters
- **Bedrock**: Generate profile content using Claude

## Error Handling

### IAM Model Not Found
```python
ValueError: "IAM model outputs must be generated before Security Research Profile"
```
**Cause**: GenerateIAMModel hasn't run or failed
**Resolution**: Ensure GenerateIAMModel completes successfully before this function

### No Validated Actions
```python
ValueError: "No validated actions found in service documentation"
```
**Cause**: Service has no IAM actions in DynamoDB
**Resolution**: Verify ValidateAndCollectServiceData collected actions

## Testing

```bash
# Run unit tests
python tests/test_security_research_profile.py

# Test with real service (requires AWS credentials)
python scripts/test_generate_service_profile.py --service ssm
```

## Example Output

See: `tests/output/ssm/service-profiles/security_research_profile.md`

Compare with sample Word documents:
- `tests/sample/AWS Research Profile - AWS Gateway Load Balancer.docx`
- `tests/sample/AWS Research Profile - AWS Network Load Balancer.docx`

## Configuration

### Bedrock Model
Default: `claude-4` (configured in `bedrock_client`)

To change model:
```python
bedrock_client = get_bedrock_client('nova-pro')  # or 'claude-4'
```

### Timeout
- **Lambda**: 15 minutes
- **Memory**: 1024 MB

## Monitoring

### CloudWatch Metrics
- Invocations
- Duration
- Errors
- Throttles

### CloudWatch Logs
- Log Group: `/aws/lambda/gensec-GenerateServiceProfile`
- Key log messages:
  - "Loading IAM model outputs from S3"
  - "Generating Security Research Profile for: {service}"
  - "Calling Bedrock to generate Security Research Profile"
  - "Stored Security Research Profile for service: {service_id}"

## Migration Notes

### Changes (v2.0)
- **Workflow order changed**: Now runs AFTER GenerateIAMModel (was before)
- **Output format enhanced**: Now generates BOTH original profile AND Security Research Profile
- **New S3 dependency**: Requires IAM model outputs in S3

### Backward Compatibility
- ✅ **Fully backward compatible**: Original `service-profiles/profile.json` and `profile.md` still generated
- ✅ **New output added**: `service-profiles/security_research_profile.md` (comprehensive security evaluation)
- ✅ **No breaking changes**: Existing downstream consumers continue to work

## Related Documentation
- [Step Function Workflow](../ARCHITECTURE.md#step-function-workflow)
- [GenerateIAMModel](./GenerateIAMModel.md)
- [Security Research Profile Format](../security-research-profile-format.md)
