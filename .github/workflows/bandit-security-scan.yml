name: Bandit Security Scan

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:

jobs:
  bandit-scan:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install Bandit
      run: |
        pip install bandit[sarif]
    
    - name: Verify Python files exist
      run: |
        echo "Checking for Python files..."
        find . -name "*.py" -type f | head -20
        echo "Total Python files found:"
        find . -name "*.py" -type f | wc -l
    
    - name: Run Bandit scan (SARIF for Security tab)
      run: |
        echo "Running Bandit scan on ALL Python files..."
        bandit -r . -f sarif -o bandit-report.sarif --exit-zero --exclude .git || true
        echo "Checking SARIF output..."
        if [ -f bandit-report.sarif ]; then
          echo "SARIF file created successfully"
          cat bandit-report.sarif | head -50
        else
          echo "Warning: SARIF file not created"
        fi
      continue-on-error: true
    
    - name: Upload SARIF file to GitHub Security
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: bandit-report.sarif
      if: always() && hashFiles('bandit-report.sarif') != ''
    
    - name: Run Bandit scan (detailed output)
      run: |
        echo "Running detailed Bandit scan on ALL files..."
        bandit -r . -f json -o bandit-report.json --exclude .git || true
        echo ""
        echo "=== Bandit Security Scan Results ==="
        bandit -r . -f screen --exclude .git || true
    
    - name: Analyze results and fail on HIGH/MEDIUM severity
      if: always()
      run: |
        python3 .github/scripts/analyze_bandit_results.py
    
    - name: Comment on PR with results
      if: always() && github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          
          // Check if report exists
          if (!fs.existsSync('bandit-report.json')) {
            return;
          }
          
          const data = JSON.parse(fs.readFileSync('bandit-report.json', 'utf8'));
          const results = data.results || [];
          
          const high = results.filter(r => r.issue_severity === 'HIGH');
          const medium = results.filter(r => r.issue_severity === 'MEDIUM');
          const low = results.filter(r => r.issue_severity === 'LOW');
          
          const critical = high.length + medium.length;
          
          let comment = '## ðŸ”’ Bandit Security Scan Results\n\n';
          comment += `ðŸ“Š **Summary:** ${results.length} total issues found\n`;
          comment += `- ðŸ”´ **HIGH:** ${high.length}\n`;
          comment += `- ðŸŸ¡ **MEDIUM:** ${medium.length}\n`;
          comment += `- ðŸŸ¢ **LOW:** ${low.length}\n\n`;
          
          if (critical > 0) {
            comment += '---\n\n';
            comment += '### âŒ Build Failed - Action Required\n\n';
            comment += `Found **${critical} critical security issues** that must be fixed before merging.\n\n`;
            
            if (high.length > 0) {
              comment += '#### ðŸ”´ HIGH Severity Issues\n\n';
              high.forEach((issue, i) => {
                comment += `${i + 1}. **${issue.test_id}**: ${issue.issue_text}\n`;
                comment += `   - **File:** \`${issue.filename}:${issue.line_number}\`\n`;
                comment += `   - **Confidence:** ${issue.issue_confidence}\n`;
                comment += `   - [Documentation](${issue.more_info})\n\n`;
              });
            }
            
            if (medium.length > 0) {
              comment += '#### ðŸŸ¡ MEDIUM Severity Issues\n\n';
              medium.forEach((issue, i) => {
                comment += `${i + 1}. **${issue.test_id}**: ${issue.issue_text}\n`;
                comment += `   - **File:** \`${issue.filename}:${issue.line_number}\`\n`;
                comment += `   - [Documentation](${issue.more_info})\n\n`;
              });
            }
            
            comment += '---\n\n';
            comment += '### ðŸ”§ How to Fix\n\n';
            comment += '1. Review each issue using the documentation links above\n';
            comment += '2. Fix the security vulnerabilities in your code\n';
            comment += '3. If false positive, add `# nosec` comment with justification\n';
            comment += '4. Push your changes to re-run the scan\n\n';
            comment += 'ðŸ’¡ **Tip:** Click on the "Files changed" tab to see inline annotations on the affected lines.\n';
          } else {
            comment += '---\n\n';
            comment += '### âœ… Security Scan Passed\n\n';
            if (results.length === 0) {
              comment += 'ðŸŽ‰ No security issues found!\n';
            } else {
              comment += `Found ${low.length} LOW severity issues (informational only).\n`;
            }
          }
          
          // Post comment
          await github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
            body: comment
          });
