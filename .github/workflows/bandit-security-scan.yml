name: Bandit Security Scan

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:

jobs:
  bandit-scan:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install Bandit
      run: |
        pip install bandit[sarif]
    
    - name: Verify Python files exist
      run: |
        echo "Checking for Python files..."
        find . -name "*.py" -type f | head -20
        echo "Total Python files found:"
        find . -name "*.py" -type f | wc -l
    
    - name: Run Bandit scan (SARIF for Security tab)
      run: |
        echo "Running Bandit scan on ALL Python files..."
        bandit -r . -f sarif -o bandit-report.sarif --exit-zero --exclude .git || true
        echo "Checking SARIF output..."
        if [ -f bandit-report.sarif ]; then
          echo "SARIF file created successfully"
          cat bandit-report.sarif | head -50
        else
          echo "Warning: SARIF file not created"
        fi
      continue-on-error: true
    
    - name: Upload SARIF file to GitHub Security
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: bandit-report.sarif
      if: always() && hashFiles('bandit-report.sarif') != ''
    
    - name: Run Bandit scan (detailed output)
      run: |
        echo "Running detailed Bandit scan on ALL files..."
        bandit -r . -f json -o bandit-report.json --exclude .git || true
        echo ""
        echo "=== Bandit Security Scan Results ==="
        bandit -r . -f screen --exclude .git || true
    
    - name: Analyze results and fail on HIGH/MEDIUM severity
      if: always()
      run: |
        if [ -f bandit-report.json ]; then
          echo "=== Security Scan Summary ==="
          
          # Parse the JSON report
          TOTAL_ISSUES=$(python3 -c "import json; d=json.load(open('bandit-report.json')); print(len(d['results']))")
          HIGH_ISSUES=$(python3 -c "import json; d=json.load(open('bandit-report.json')); print(len([r for r in d['results'] if r['issue_severity']=='HIGH']))")
          MEDIUM_ISSUES=$(python3 -c "import json; d=json.load(open('bandit-report.json')); print(len([r for r in d['results'] if r['issue_severity']=='MEDIUM']))")
          LOW_ISSUES=$(python3 -c "import json; d=json.load(open('bandit-report.json')); print(len([r for r in d['results'] if r['issue_severity']=='LOW']))")
          
          echo "ðŸ“Š Total Issues Found: $TOTAL_ISSUES"
          echo "ðŸ”´ HIGH Severity: $HIGH_ISSUES"
          echo "ðŸŸ¡ MEDIUM Severity: $MEDIUM_ISSUES"
          echo "ðŸŸ¢ LOW Severity: $LOW_ISSUES"
          echo ""
          
          # Create GitHub annotations for all issues
          python3 << 'EOF'
import json
with open('bandit-report.json') as f:
    data = json.load(f)
    for issue in data['results']:
        severity = issue['issue_severity']
        filename = issue['filename'].lstrip('./')
        line = issue['line_number']
        test_id = issue['test_id']
        text = issue['issue_text']
        
        # Map severity to GitHub annotation level
        if severity == 'HIGH':
            level = 'error'
        elif severity == 'MEDIUM':
            level = 'error'  # Changed to error to make it more visible
        else:
            level = 'notice'
        
        # Create GitHub annotation
        print(f"::{level} file={filename},line={line},title=Bandit {test_id} ({severity})::{text}")
EOF
          
          # Check if we need to fail the build
          CRITICAL_ISSUES=$((HIGH_ISSUES + MEDIUM_ISSUES))
          
          if [ "$CRITICAL_ISSUES" -gt 0 ]; then
            echo ""
            echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
            echo "â•‘                                                                â•‘"
            echo "â•‘  âŒ âŒ âŒ  SECURITY ISSUES DETECTED - BUILD FAILED  âŒ âŒ âŒ  â•‘"
            echo "â•‘                                                                â•‘"
            echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo ""
          fi
          
          # Display HIGH severity issues
          if [ "$HIGH_ISSUES" -gt 0 ]; then
            echo "ðŸ”´ HIGH SEVERITY ISSUES (MUST FIX) ðŸ”´"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            python3 << 'EOF'
import json
with open('bandit-report.json') as f:
    data = json.load(f)
    high_issues = [r for r in data['results'] if r['issue_severity'] == 'HIGH']
    for i, issue in enumerate(high_issues, 1):
        print(f"\nðŸ”´ Issue #{i}: {issue['test_id']}")
        print(f"   Description: {issue['issue_text']}")
        print(f"   Location: {issue['filename']}:{issue['line_number']}")
        print(f"   Confidence: {issue['issue_confidence']}")
        print(f"   CWE: {issue.get('issue_cwe', {}).get('id', 'N/A')}")
        print(f"   Documentation: {issue['more_info']}")
        if 'code' in issue:
            print(f"   Code: {issue['code'][:100]}...")
EOF
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo ""
          fi
          
          # Display MEDIUM severity issues
          if [ "$MEDIUM_ISSUES" -gt 0 ]; then
            echo "ðŸŸ¡ MEDIUM SEVERITY ISSUES (MUST FIX) ðŸŸ¡"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            python3 << 'EOF'
import json
with open('bandit-report.json') as f:
    data = json.load(f)
    medium_issues = [r for r in data['results'] if r['issue_severity'] == 'MEDIUM']
    for i, issue in enumerate(medium_issues, 1):
        print(f"\nðŸŸ¡ Issue #{i}: {issue['test_id']}")
        print(f"   Description: {issue['issue_text']}")
        print(f"   Location: {issue['filename']}:{issue['line_number']}")
        print(f"   Confidence: {issue['issue_confidence']}")
        print(f"   Documentation: {issue['more_info']}")
EOF
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo ""
          fi
          
          # Display LOW severity issues as informational
          if [ "$LOW_ISSUES" -gt 0 ]; then
            echo "â„¹ï¸  LOW SEVERITY ISSUES (INFORMATIONAL) â„¹ï¸"
            echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
            python3 << 'EOF'
import json
with open('bandit-report.json') as f:
    data = json.load(f)
    low_issues = [r for r in data['results'] if r['issue_severity'] == 'LOW']
    for i, issue in enumerate(low_issues, 1):
        print(f"  {i}. {issue['test_id']}: {issue['issue_text'][:80]}")
        print(f"     {issue['filename']}:{issue['line_number']}")
EOF
            echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
            echo ""
          fi
          
          # Final verdict
          if [ "$CRITICAL_ISSUES" -gt 0 ]; then
            echo ""
            echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
            echo "â•‘                                                                â•‘"
            echo "â•‘  â›” ACTION REQUIRED: Fix all HIGH and MEDIUM severity issues  â•‘"
            echo "â•‘                                                                â•‘"
            echo "â•‘  Found: $HIGH_ISSUES HIGH + $MEDIUM_ISSUES MEDIUM = $CRITICAL_ISSUES issues to resolve              â•‘"
            echo "â•‘                                                                â•‘"
            echo "â•‘  This build will fail until all critical issues are fixed.    â•‘"
            echo "â•‘                                                                â•‘"
            echo "â•‘  Options to resolve:                                           â•‘"
            echo "â•‘  1. Fix the security issues in your code                      â•‘"
            echo "â•‘  2. Use # nosec comment if false positive (with justification)â•‘"
            echo "â•‘  3. Update .bandit config to skip specific tests (not recommended)â•‘"
            echo "â•‘                                                                â•‘"
            echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo ""
            exit 1
          else
            echo ""
            echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
            echo "â•‘                                                                â•‘"
            echo "â•‘  âœ… âœ… âœ…  SECURITY SCAN PASSED  âœ… âœ… âœ…                      â•‘"
            echo "â•‘                                                                â•‘"
            echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo ""
            if [ "$TOTAL_ISSUES" -eq 0 ]; then
              echo "ðŸŽ‰ No security issues found!"
            else
              echo "â„¹ï¸  Found $LOW_ISSUES LOW severity issues (informational only)"
            fi
          fi
        else
          echo "âŒ Error: bandit-report.json not found"
          exit 1
        fi
