name: Auto-Revert Security Failures

# This workflow automatically reverts commits on main branch that fail security scans
# ONLY USE THIS IF: You want automatic rollback for direct pushes to main
# NOTE: With branch protection enabled, this should rarely be needed

on:
  workflow_run:
    workflows: ["Bandit Security Scan"]
    types:
      - completed
    branches:
      - main

jobs:
  auto-revert:
    runs-on: ubuntu-latest
    # Only run if the security scan failed AND it was a push to main (not a PR)
    if: |
      github.event.workflow_run.conclusion == 'failure' &&
      github.event.workflow_run.event == 'push'
    
    permissions:
      contents: write
      pull-requests: write
      issues: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Need full history for revert
        ref: main
    
    - name: Get failed commit info
      id: commit_info
      run: |
        COMMIT_SHA="${{ github.event.workflow_run.head_sha }}"
        COMMIT_MSG=$(git log -1 --pretty=%B $COMMIT_SHA)
        COMMIT_AUTHOR=$(git log -1 --pretty=%an $COMMIT_SHA)
        
        echo "sha=$COMMIT_SHA" >> $GITHUB_OUTPUT
        echo "message=$COMMIT_MSG" >> $GITHUB_OUTPUT
        echo "author=$COMMIT_AUTHOR" >> $GITHUB_OUTPUT
    
    - name: Create revert commit
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        
        # Revert the commit
        git revert --no-edit ${{ steps.commit_info.outputs.sha }}
        
        # Push the revert
        git push origin main
    
    - name: Create issue to notify team
      uses: actions/github-script@v7
      with:
        script: |
          const commitSha = '${{ steps.commit_info.outputs.sha }}';
          const commitMsg = '${{ steps.commit_info.outputs.message }}';
          const commitAuthor = '${{ steps.commit_info.outputs.author }}';
          
          const issueBody = `## ðŸš¨ Automatic Revert: Security Scan Failure
          
          A commit was automatically reverted from the \`main\` branch due to security scan failures.
          
          ### Reverted Commit
          - **SHA:** \`${commitSha.substring(0, 7)}\`
          - **Author:** ${commitAuthor}
          - **Message:** ${commitMsg}
          - **Link:** ${context.payload.repository.html_url}/commit/${commitSha}
          
          ### Reason
          The commit failed the Bandit security scan with HIGH or MEDIUM severity issues.
          
          ### What Happened
          1. Commit was pushed directly to \`main\` branch
          2. Security scan detected critical vulnerabilities
          3. Commit was automatically reverted to protect the codebase
          
          ### Next Steps
          1. Review the security scan results: [View Workflow Run](${context.payload.workflow_run.html_url})
          2. Fix the security issues in a feature branch
          3. Create a Pull Request with the fixes
          4. Ensure security scan passes before merging
          
          ### Prevention
          - Always use Pull Requests instead of direct pushes to \`main\`
          - Branch protection rules should prevent this scenario
          - Review branch protection settings if this happens frequently
          
          @${commitAuthor} - Please review and fix the security issues.
          `;
          
          await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: `ðŸš¨ Auto-Revert: Security failure in ${commitSha.substring(0, 7)}`,
            body: issueBody,
            labels: ['security', 'auto-revert', 'urgent']
          });
    
    - name: Send notification
      uses: actions/github-script@v7
      with:
        script: |
          console.log('ðŸš¨ AUTOMATIC REVERT EXECUTED');
          console.log('Commit ${{ steps.commit_info.outputs.sha }} was reverted due to security scan failure');
          console.log('An issue has been created to track this incident');
